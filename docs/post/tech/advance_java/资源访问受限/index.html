<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>资源访问受限—Java并发系列之二 - Endless River</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="wangy325" /><meta name="description" content="在系列一中，虽然创建了多线程，并且线程之间出现了一些不可预测的CPU调度，但是由于线程之间是相互隔离的——线程没有访问共同的资源，尽管在执行任务的过程可能被CPU剥夺运行权，但是当它们再次获得运行权时对运行结果并没有影响，它们是安全的
" />






<meta name="generator" content="Hugo 0.55.6 with even 4.0.0" />


<link rel="canonical" href="https://wangy325.github.io/endlessriver/post/tech/advance_java/%E8%B5%84%E6%BA%90%E8%AE%BF%E9%97%AE%E5%8F%97%E9%99%90/" />
<link rel="apple-touch-icon" sizes="180x180" href="/endlessriver/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/endlessriver/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/endlessriver/favicon-16x16.png">
<link rel="manifest" href="/endlessriver/manifest.json">
<link rel="mask-icon" href="/endlessriver/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/endlessriver/dist/even.f64a7681.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="资源访问受限—Java并发系列之二" />
<meta property="og:description" content="在系列一中，虽然创建了多线程，并且线程之间出现了一些不可预测的CPU调度，但是由于线程之间是相互隔离的——线程没有访问共同的资源，尽管在执行任务的过程可能被CPU剥夺运行权，但是当它们再次获得运行权时对运行结果并没有影响，它们是安全的" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wangy325.github.io/endlessriver/post/tech/advance_java/%E8%B5%84%E6%BA%90%E8%AE%BF%E9%97%AE%E5%8F%97%E9%99%90/" />
<meta property="article:published_time" content="2020-05-15T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2020-05-28T19:52:52&#43;08:00"/>

<meta itemprop="name" content="资源访问受限—Java并发系列之二">
<meta itemprop="description" content="在系列一中，虽然创建了多线程，并且线程之间出现了一些不可预测的CPU调度，但是由于线程之间是相互隔离的——线程没有访问共同的资源，尽管在执行任务的过程可能被CPU剥夺运行权，但是当它们再次获得运行权时对运行结果并没有影响，它们是安全的">


<meta itemprop="datePublished" content="2020-05-15T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-05-28T19:52:52&#43;08:00" />
<meta itemprop="wordCount" content="9285">



<meta itemprop="keywords" content="Java进阶," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="资源访问受限—Java并发系列之二"/>
<meta name="twitter:description" content="在系列一中，虽然创建了多线程，并且线程之间出现了一些不可预测的CPU调度，但是由于线程之间是相互隔离的——线程没有访问共同的资源，尽管在执行任务的过程可能被CPU剥夺运行权，但是当它们再次获得运行权时对运行结果并没有影响，它们是安全的"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/endlessriver/" class="logo">Endless River</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/endlessriver/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/endlessriver/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/endlessriver/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/endlessriver/about/">
        <li class="mobile-menu-item">关于</li>
      </a><a href="/endlessriver/friendlink/">
        <li class="mobile-menu-item">友链</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/endlessriver/" class="logo">Endless River</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/endlessriver/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/endlessriver/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/endlessriver/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/endlessriver/about/">关于</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/endlessriver/friendlink/">友链</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">资源访问受限—Java并发系列之二</h1>

      <div class="post-meta">
          <span>
              <span class="icomoonfree icon-calendar"></span>
              <span class="post-time"> 2020-05-15</span>
          </span>

        <div class="post-category">
              <span class="icomoonfree icon-folder"></span>
            <a href="/endlessriver/categories/java/"> Java </a>
            </div>
          <span class="icomoonfree icon-sigma"></span>
          <span class="more-meta analyse"> 约 9285 字 </span>
          <span class="icomoonfree icon-clock"></span>
          <span class="more-meta analyse"> 预计阅读 19 分钟 </span>
        <span class="icomoonfree icon-eye"></span>
          <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/endlessriver/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#13-2-1-可重入锁">13.2.1 可重入锁</a></li>
<li><a href="#13-2-2-span-id-condition-条件-span">13.2.2 <span id="condition">条件</span></a></li>
<li><a href="#13-2-3-synchronized关键字">13.2.3 synchronized关键字</a>
<ul>
<li><a href="#同步方法">同步方法</a></li>
<li><a href="#同步代码块">同步代码块</a></li>
</ul></li>
<li><a href="#13-2-4-原子性与原子类">13.2.4 原子性与原子类</a></li>
<li><a href="#13-2-5-可见性">13.2.5 可见性</a></li>
<li><a href="#13-2-6-临界区">13.2.6 临界区</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>在系列一中，虽然创建了多线程，并且线程之间出现了一些<strong>不可预测</strong>的CPU调度，但是由于线程之间是<strong>相互隔离</strong>的——<strong>线程没有访问共同的资源</strong>，尽管在执行任务的过程可能被CPU剥夺运行权，但是当它们再次获得运行权时对运行结果并没有影响，它们是安全的</p>

<p>考虑一种情况，如果<strong>多个线程访问同一个资源</strong>，并对资源内容进行修改，会发生什么情况？</p>

<p>对于<strong>非原子性</strong>操作，多线程下会出现<strong>竞争条件</strong>，<code>accounts[to] += amount</code>操作，可以被拆分为多个CPU指令：</p>

<ul>
<li>加载accounts[to]到寄存器</li>
<li>增加amount</li>
<li>将结果写回acounts[to]</li>
</ul>

<p>线程运行到<strong>任何一个步骤时都可能被剥夺运行权</strong></p>

<p>考虑一个经典的“转账”示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnsynchronizedTransfer</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">double</span> <span class="n">INITIAL_MONEY</span> <span class="o">=</span> <span class="n">1000</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">ACCOUNTS</span> <span class="o">=</span> <span class="n">100</span><span class="o">;</span>
        <span class="n">Bank</span> <span class="n">bank</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bank</span><span class="o">(</span><span class="n">ACCOUNTS</span><span class="o">,</span> <span class="n">INITIAL_MONEY</span><span class="o">);</span>
				<span class="c1">// 可以增加循环次数观察“出错”的概率提升
</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">2</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          	<span class="c1">// 多个线程使用同一个bank资源
</span><span class="c1"></span>            <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">TransferTask</span><span class="o">(</span><span class="n">bank</span><span class="o">));</span>
            <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TransferTask</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="n">Bank</span> <span class="n">bank</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">size</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">double</span> <span class="n">maxAmount</span> <span class="o">=</span> <span class="n">1000</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">TransferTask</span><span class="o">(</span><span class="n">Bank</span> <span class="n">bank</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">bank</span> <span class="o">=</span> <span class="n">bank</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">=</span> <span class="n">bank</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">from</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">random</span><span class="o">());</span>
                <span class="kt">int</span> <span class="n">to</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">random</span><span class="o">());</span>
                <span class="kt">double</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">maxAmount</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">random</span><span class="o">();</span>
                <span class="n">bank</span><span class="o">.</span><span class="na">transfer</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">to</span><span class="o">,</span> <span class="n">amount</span><span class="o">);</span>
                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">((</span><span class="kt">long</span><span class="o">)</span> <span class="o">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()));</span>
            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
                <span class="c1">// e.printStackTrace();
</span><span class="c1"></span>            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Bank</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">double</span><span class="o">[]</span> <span class="n">accounts</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Bank</span><span class="o">(</span><span class="kt">int</span> <span class="n">accountCount</span><span class="o">,</span> <span class="kt">double</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// initialize bank account
</span><span class="c1"></span>            <span class="n">accounts</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="o">[</span><span class="n">accountCount</span><span class="o">];</span>
            <span class="n">Arrays</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="n">accounts</span><span class="o">,</span> <span class="n">money</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="kt">int</span> <span class="n">from</span><span class="o">,</span> <span class="kt">int</span> <span class="n">to</span><span class="o">,</span> <span class="kt">double</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">accounts</span><span class="o">[</span><span class="n">from</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">from</span> <span class="o">==</span> <span class="n">to</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
            <span class="c1">// transfer
</span><span class="c1"></span>            <span class="n">accounts</span><span class="o">[</span><span class="n">from</span><span class="o">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="o">;</span>
          	<span class="c1">// 这句打印语句增加了调度器剥夺线程运行权的风险
</span><span class="c1"></span>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; move away&#34;</span><span class="o">);</span>
            <span class="n">accounts</span><span class="o">[</span><span class="n">to</span><span class="o">]</span> <span class="o">+=</span> <span class="n">amount</span><span class="o">;</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;%s: %10.2f from %d to %d, Total Balance: %10.2f%n&#34;</span><span class="o">,</span>
                <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">(),</span>
                <span class="n">amount</span><span class="o">,</span>
                <span class="n">from</span><span class="o">,</span>
                <span class="n">to</span><span class="o">,</span>
                <span class="n">totalBalance</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">double</span> <span class="nf">totalBalance</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">double</span> <span class="n">a</span> <span class="o">:</span> <span class="n">accounts</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sum</span> <span class="o">+=</span> <span class="n">a</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">accounts</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">/*</span> <span class="nl">output:</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">1</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]</span> <span class="n">move</span> <span class="n">away</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">0</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]</span> <span class="n">move</span> <span class="n">away</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">1</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]:</span>     <span class="n">217</span><span class="o">.</span><span class="na">65</span> <span class="n">from</span> <span class="n">30</span> <span class="n">to</span> <span class="n">20</span><span class="o">,</span> <span class="n">Total</span> <span class="nl">Balance:</span>   <span class="n">99445</span><span class="o">.</span><span class="na">52</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">0</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]:</span>     <span class="n">554</span><span class="o">.</span><span class="na">48</span> <span class="n">from</span> <span class="n">55</span> <span class="n">to</span> <span class="n">53</span><span class="o">,</span> <span class="n">Total</span> <span class="nl">Balance:</span>  <span class="n">100000</span><span class="o">.</span><span class="na">00</span>
<span class="o">///</span><span class="err">：～</span></code></pre></td></tr></table>
</div>
</div>
<p>上例中，使用多个线程访问了Bank类的资源，在Bank类的transfer()方法中，额外增加了一句控制台输出，这是为了增加线程被调度的可能性[^8] （如果注释这句，会发现程序异常的概率会变小）。Bank类初始化时分配100个“账户”，每个账户1000元，然后不断转账，观察所有账户总额的变化</p>

<p>仔细观察输出（循环2次，出现的概率较小），我们看到:</p>

<ol>
<li><p>线程1在输出 <em>move away</em> 之后被剥夺运行权</p></li>

<li><p>接着线程0在 <em>move away</em> 之后也被剥夺运行权</p></li>

<li><p>线程1继续运行，此时问题就出现了，总金额不是100000：</p></li>
</ol>

<p>在计算总额时，线程1获取账户55的余额时少了554.48元，这正是第2步中线程0的<code>accounts[from] -= amount</code>将账户55的余额减少的金额</p>

<p>实际上CPU的调度过程比上述分析复杂得多，在Bank类的transfer()方法中，<strong>每一行代码在运行时都可能被剥夺运行权</strong>，值得一提及的是，上例输出操作的还不是相同的“账户”，若是操作同样的“账户”，情况将变得更复杂</p>

<p>所以说线程不安全是一种<strong>不确定性</strong>，在有限的线程时，它可能发生也可能不发生，比如main()方法里只循环1次时就不会发生，循环100次就极大概率会发生。并发编程就是要<strong>消除这种不确定性</strong></p>

<p>在<span id = "evenGenerator">接下来的示例中</span>，有一个生成偶数的工具类，在多线程条件下调用生成偶数的方法并加以判断，若发现不是偶数则退出程序：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnSynchronizedEvenGenerator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;press Ctrl-C to exit&#34;</span><span class="o">);</span>
        <span class="n">EvenGenerator</span> <span class="n">evenGenerator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EvenGenerator</span><span class="o">();</span>
        <span class="n">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">3</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
           <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">EvenTask</span><span class="o">(</span><span class="n">evenGenerator</span><span class="o">)));</span>
        <span class="o">}</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractIntGenerator</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">canceled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

        <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">next</span><span class="o">();</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">cancel</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">canceled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isCanceled</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">canceled</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">EvenGenerator</span> <span class="kd">extends</span> <span class="n">AbstractIntGenerator</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">even</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
            <span class="o">++</span><span class="n">even</span><span class="o">;</span>  <span class="c1">// danger here!
</span><span class="c1"></span>            <span class="o">++</span><span class="n">even</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">even</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">EvenTask</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="n">EvenGenerator</span> <span class="n">evenGenerator</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">EvenTask</span><span class="o">(</span><span class="n">EvenGenerator</span> <span class="n">evenGenerator</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">evenGenerator</span> <span class="o">=</span> <span class="n">evenGenerator</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(!</span><span class="n">evenGenerator</span><span class="o">.</span><span class="na">isCanceled</span><span class="o">())</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="n">evenGenerator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">%</span> <span class="n">2</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">toString</span><span class="o">()</span>
                                       <span class="o">+</span> <span class="n">next</span> <span class="o">+</span> <span class="s">&#34; not even!&#34;</span><span class="o">);</span>
                    <span class="n">evenGenerator</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">/*</span> <span class="nl">output:</span> <span class="o">(</span><span class="n">sample</span><span class="o">)</span>
<span class="n">press</span> <span class="n">Ctrl</span><span class="o">-</span><span class="n">C</span> <span class="n">to</span> <span class="n">exit</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">pool</span><span class="o">-</span><span class="n">1</span><span class="o">-</span><span class="n">thread</span><span class="o">-</span><span class="n">2</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]</span><span class="n">1427</span> <span class="n">not</span> <span class="n">even</span><span class="o">!</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">pool</span><span class="o">-</span><span class="n">1</span><span class="o">-</span><span class="n">thread</span><span class="o">-</span><span class="n">1</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]</span><span class="n">1425</span> <span class="n">not</span> <span class="n">even</span><span class="o">!</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">pool</span><span class="o">-</span><span class="n">1</span><span class="o">-</span><span class="n">thread</span><span class="o">-</span><span class="n">3</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]</span><span class="n">1429</span> <span class="n">not</span> <span class="n">even</span><span class="o">!</span>
<span class="o">///:~</span></code></pre></td></tr></table>
</div>
</div>
<p>上例中，当循环次数只有1次时，程序会一致执行，直到按下Ctrl-C手动结束任务；而当循环次数大于1时，无论其运行多长时间，其总会结束。</p>

<p>AbstractIntGenerator类中的canceled标志是基本数据类型，而Java内存模型规定，所有<strong>原始类型对象（除了double和long）的读写都是原子的</strong><sup class="footnote-ref" id="fnref:15"><a href="#fn:15">1</a></sup>；并且由<strong>volatile</strong>修饰，说明其是<strong>可见的</strong>，因此当发生错误时，所有线程都能读取到cancel信息而退出</p>

<p>EvenGenerator类中通过两次<strong>自增运算</strong>获取下一个偶数，这在单线程下是没问题的，但是<strong>自增运算也不是原子性操作</strong>，其仍可被拆分为多个CPU指令<sup class="footnote-ref" id="fnref:12"><a href="#fn:12">2</a></sup>，并且被调度器剥夺运行权，在多线程条件下问题就会显现</p>

<blockquote>
<p>如何确定自增运算不是原子性的呢？</p>

<p>以下是<code>javap -c -v UnSynchronizedEvenGenerator\$EvenGenerator</code>输出的<span id ="byteCode">字节码</span>（部分）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">int</span> <span class="nf">next</span><span class="o">();</span><span class="nl">
</span><span class="nl"> descriptor:</span> <span class="o">()</span><span class="n">I</span><span class="nl">
</span><span class="nl"> flags:</span> <span class="n">ACC_PUBLIC</span><span class="nl">
</span><span class="nl"> Code:</span>
   <span class="n">stack</span><span class="o">=</span><span class="n">3</span><span class="o">,</span> <span class="n">locals</span><span class="o">=</span><span class="n">1</span><span class="o">,</span> <span class="n">args_size</span><span class="o">=</span><span class="n">1</span><span class="nl">
</span><span class="nl">      0:</span> <span class="n">aload_0</span><span class="nl">
</span><span class="nl">      1:</span> <span class="n">dup</span><span class="nl">
</span><span class="nl">      2:</span> <span class="n">getfield</span>      <span class="err">#</span><span class="n">2</span>                  <span class="c1">// Field even:I
</span><span class="c1"></span>      <span class="nl">5:</span> <span class="n">iconst_1</span><span class="nl">
</span><span class="nl">      6:</span> <span class="n">iadd</span><span class="nl">
</span><span class="nl">      7:</span> <span class="n">putfield</span>      <span class="err">#</span><span class="n">2</span>                  <span class="c1">// Field even:I
</span><span class="c1"></span>     <span class="nl">10:</span> <span class="n">aload_0</span><span class="nl">
</span><span class="nl">     11:</span> <span class="n">dup</span><span class="nl">
</span><span class="nl">     12:</span> <span class="n">getfield</span>      <span class="err">#</span><span class="n">2</span>                  <span class="c1">// Field even:I
</span><span class="c1"></span>     <span class="nl">15:</span> <span class="n">iconst_1</span><span class="nl">
</span><span class="nl">     16:</span> <span class="n">iadd</span><span class="nl">
</span><span class="nl">     17:</span> <span class="n">putfield</span>      <span class="err">#</span><span class="n">2</span>                  <span class="c1">// Field even:I
</span><span class="c1"></span>     <span class="nl">20:</span> <span class="n">aload_0</span><span class="nl">
</span><span class="nl">     21:</span> <span class="n">getfield</span>      <span class="err">#</span><span class="n">2</span>                  <span class="c1">// Field even:I
</span><span class="c1"></span>     <span class="nl">24:</span> <span class="n">ireturn</span></code></pre></td></tr></table>
</div>
</div>
<p>可以看到，一个自增操作被拆分为至少<sup class="footnote-ref" id="fnref:13"><a href="#fn:13">3</a></sup>3个步骤：</p>

<ol>
<li>get字段even</li>
<li>add修改even</li>
<li>put设置even</li>
</ol>

<p>在未同步的情况下，其中执行到其中任何一步的时候都可能被CPU剥夺运行权</p>
</blockquote>

<p>如何解决多线程下共享资源的竞争条件呢？</p>

<p>基本上所有的并发模式在解决线程冲突问题时，都采用<strong>序列化访问共享资源</strong>的方式。即同一时刻只允许某一个线程访问资源，其他线程被阻塞。通常是通过在代码前面加上一条<strong>锁语句</strong>来实现的，由于锁产生了一种互斥的效果，这种机制也被称为<strong>互斥量</strong>（ <em>mutex</em> ）</p>

<h3 id="13-2-1-可重入锁">13.2.1 可重入锁</h3>

<p>Java SE 5之后提供了位于<code>java.util.concurrent.locks</code>包下的显式<strong>互斥机制</strong>——Lock对象（显式锁），Lock对象必须被<strong>显示的创建，锁定和释放</strong></p>

<p>一般情况下 ，ReentrantLock保护代码块的基本结构是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">myLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span> <span class="c1">// 可重入锁
</span><span class="c1"></span><span class="k">try</span><span class="o">{</span>
  <span class="c1">// 临界区代码
</span><span class="c1"></span><span class="o">}</span><span class="k">finally</span><span class="o">{</span>
  <span class="n">myLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这个结构可以确保只有一个线程进入<strong>临界区</strong>( <em>critical section</em> )，其他线程调用lock()时会被阻塞，直到第一个线程释放锁</p>

<p>我们利用锁机制来修改之前的转账逻辑，看看会发生什么：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kd">class</span> <span class="nc">Bank</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">double</span><span class="o">[]</span> <span class="n">accounts</span><span class="o">;</span>
  <span class="c1">// lock
</span><span class="c1"></span>  <span class="kd">private</span> <span class="n">Lock</span> <span class="n">lock</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Bank</span><span class="o">(</span><span class="kt">int</span> <span class="n">accountCount</span><span class="o">,</span> <span class="kt">double</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// initialize bank account
</span><span class="c1"></span>    <span class="n">accounts</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="o">[</span><span class="n">accountCount</span><span class="o">];</span>
    <span class="n">Arrays</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="n">accounts</span><span class="o">,</span> <span class="n">money</span><span class="o">);</span>
    <span class="c1">// 使用可重入锁
</span><span class="c1"></span>    <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="kt">int</span> <span class="n">from</span><span class="o">,</span> <span class="kt">int</span> <span class="n">to</span><span class="o">,</span> <span class="kt">double</span> <span class="n">amount</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">accounts</span><span class="o">[</span><span class="n">from</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">from</span> <span class="o">==</span> <span class="n">to</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
      <span class="c1">// transfer
</span><span class="c1"></span>      <span class="n">accounts</span><span class="o">[</span><span class="n">from</span><span class="o">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="o">;</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; move away&#34;</span><span class="o">);</span>
      <span class="n">accounts</span><span class="o">[</span><span class="n">to</span><span class="o">]</span> <span class="o">+=</span> <span class="n">amount</span><span class="o">;</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;%s: %10.2f from %d to %d, Total Balance: %10.2f%n&#34;</span><span class="o">,</span>
                        <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">(),</span>
                        <span class="n">amount</span><span class="o">,</span>
                        <span class="n">from</span><span class="o">,</span>
                        <span class="n">to</span><span class="o">,</span>
                        <span class="n">totalBalance</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="c1">// 确保锁被释放
</span><span class="c1"></span>      <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">double</span> <span class="nf">totalBalance</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//lock.lock();
</span><span class="c1"></span>    <span class="c1">//try {
</span><span class="c1"></span>      <span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">double</span> <span class="n">a</span> <span class="o">:</span> <span class="n">accounts</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sum</span> <span class="o">+=</span> <span class="n">a</span><span class="o">;</span>
        <span class="o">}</span>
    	<span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
    <span class="c1">//} finally {
</span><span class="c1"></span>    <span class="c1">//	lock.unlock();
</span><span class="c1"></span>    <span class="c1">//}
</span><span class="c1"></span>  <span class="o">}</span>

  <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">accounts</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="o">/*</span> <span class="nl">output:</span> <span class="o">(</span><span class="n">partial</span><span class="o">)</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">0</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]</span> <span class="n">move</span> <span class="n">away</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">0</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]:</span>     <span class="n">948</span><span class="o">.</span><span class="na">12</span> <span class="n">from</span> <span class="n">22</span> <span class="n">to</span> <span class="n">50</span><span class="o">,</span> <span class="n">Total</span> <span class="nl">Balance:</span>  <span class="n">100000</span><span class="o">.</span><span class="na">00</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">2</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]</span> <span class="n">move</span> <span class="n">away</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">2</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]:</span>     <span class="n">722</span><span class="o">.</span><span class="na">25</span> <span class="n">from</span> <span class="n">36</span> <span class="n">to</span> <span class="n">84</span><span class="o">,</span> <span class="n">Total</span> <span class="nl">Balance:</span>  <span class="n">100000</span><span class="o">.</span><span class="na">00</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">4</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]</span> <span class="n">move</span> <span class="n">away</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">4</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]:</span>     <span class="n">621</span><span class="o">.</span><span class="na">82</span> <span class="n">from</span> <span class="n">62</span> <span class="n">to</span> <span class="n">45</span><span class="o">,</span> <span class="n">Total</span> <span class="nl">Balance:</span>  <span class="n">100000</span><span class="o">.</span><span class="na">00</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">6</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]</span> <span class="n">move</span> <span class="n">away</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">6</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]:</span>     <span class="n">628</span><span class="o">.</span><span class="na">81</span> <span class="n">from</span> <span class="n">18</span> <span class="n">to</span> <span class="n">51</span><span class="o">,</span> <span class="n">Total</span> <span class="nl">Balance:</span>  <span class="n">100000</span><span class="o">.</span><span class="na">00</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">8</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]</span> <span class="n">move</span> <span class="n">away</span>
<span class="o">...</span>
<span class="o">///:~</span></code></pre></td></tr></table>
</div>
</div>
<p>上例中，我们<strong>只对</strong>transfer()方法进行加锁，任务执行完成之后释放锁。每个线程在执行任务时都会获取锁，此时其他任务被阻塞。从控制台输出来看，也是这样的：线程是有序执行的，下一个线程总是等待上一个线程执行完才开始执行，这样，无论多少次转账，总金额也不会变</p>

<blockquote>
<p>思考一个问题：totalBalance()方法是否需要加锁？</p>
</blockquote>

<hr />

<p>上面的示例使用了<strong>可重入锁</strong><sup class="footnote-ref" id="fnref:9"><a href="#fn:9">4</a></sup>（ReentrantLock），可重入的意思是<strong>同一个线程可以重复获取锁，由一个计数器来记录锁获取的次数</strong><sup class="footnote-ref" id="fnref:11"><a href="#fn:11">5</a></sup>，它实现了Lock接口的所有方法：</p>

<blockquote>
<ul>
<li>public void lock() {&hellip;}</li>
</ul>

<p>若锁未被其他线程获取，获取锁，并将锁的<strong>计数器</strong>置为1，立即返回</p>

<p>若当前线程已经获取锁，锁的计数器+1，立即返回</p>

<p>若锁被其他线程占有，那么此线程休眠<sup class="footnote-ref" id="fnref:10"><a href="#fn:10">6</a></sup></p>

<ul>
<li>public void lockInterruptibly() throws InterruptedException {&hellip;}</li>
</ul>

<p>同lock()，不过此法可以被中断（interrupted）</p>

<ul>
<li>public boolean tryLock() {&hellip;}</li>
</ul>

<p>尝试获取锁并立即返回，成功获取同lock()并返回true，失败则返回false</p>

<ul>
<li>public boolean tryLock(long timeout, TimeUnit unit) throws InterruptedException {&hellip;}</li>
</ul>

<p>带有超时机制的尝试获取锁，此法可被中断</p>

<ul>
<li>public void unlock() {&hellip;}</li>
</ul>

<p>若计数器&gt;1，则计数器-1，不释放锁，否则计数器置为0并释放锁</p>

<ul>
<li>public Condition newCondition() {&hellip;}</li>
</ul>

<p>获取锁的条件对象</p>
</blockquote>

<p>下例展示了<strong>尝试获取锁</strong>的情况：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AttemptLocking</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="n">AttemptLocking</span> <span class="n">al</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AttemptLocking</span><span class="o">();</span>
        <span class="n">al</span><span class="o">.</span><span class="na">untimed</span><span class="o">();</span>
        <span class="n">al</span><span class="o">.</span><span class="na">timed</span><span class="o">();</span>
        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">al</span><span class="o">.</span><span class="na">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;fetched&#34;</span><span class="o">);</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// let thread-0 finish
</span><span class="c1"></span>        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">100</span><span class="o">);</span>
        <span class="n">al</span><span class="o">.</span><span class="na">untimed</span><span class="o">();</span>
        <span class="n">al</span><span class="o">.</span><span class="na">timed</span><span class="o">();</span>

    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">untimed</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">b</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;tryLock(): &#34;</span> <span class="o">+</span> <span class="n">b</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">b</span><span class="o">)</span> <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">timed</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">b</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;tryLock(2, TimeUnit.SECONDS): &#34;</span> <span class="o">+</span> <span class="n">b</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// e.printStackTrace();
</span><span class="c1"></span>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">b</span><span class="o">)</span> <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">/*</span> <span class="nl">output:</span>
<span class="n">tryLock</span><span class="o">():</span> <span class="kc">true</span>
<span class="nf">tryLock</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">):</span> <span class="kc">true</span>
<span class="n">fetched</span>
<span class="nf">tryLock</span><span class="o">():</span> <span class="kc">false</span>
<span class="nf">tryLock</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">):</span> <span class="kc">false</span>
<span class="o">///:~</span></code></pre></td></tr></table>
</div>
</div>
<p>可以看到，main()方法中使用新线程获取了锁而不释放，此时再使用方法获取锁时失败，注意timed()方法在<strong>2s等待之后才返回失败</strong></p>

<blockquote>
<p>可重入锁可以构建公平锁或非公平锁，默认使用非公平锁（上下文切换少，吞吐量高）</p>
</blockquote>

<h3 id="13-2-2-span-id-condition-条件-span">13.2.2 <span id="condition">条件</span></h3>

<p>思考转账的逻辑，当从from转帐amount到to账户时，若from余额不足，任务会直接返回。若想在from账户余额足够时再执行任务而不是直接退出，应该怎样做呢？</p>

<p><code>java.util.concurrent.locks</code>包下还提供了Condition对象，这个对象用来管理那些获得锁但是不能执行任务（条件不满足）的线程，条件可以这样使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="kt">int</span> <span class="n">from</span><span class="o">,</span> <span class="kt">int</span> <span class="n">to</span><span class="o">,</span> <span class="kt">double</span> <span class="n">amount</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
  <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">accounts</span><span class="o">[</span><span class="n">from</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// could be interrupted
</span><span class="c1"></span>      <span class="n">suficient</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
    <span class="o">};</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">from</span> <span class="o">==</span> <span class="n">to</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
    <span class="c1">// transfer
</span><span class="c1"></span>    <span class="n">accounts</span><span class="o">[</span><span class="n">from</span><span class="o">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="o">;</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; move away&#34;</span><span class="o">);</span>
    <span class="n">accounts</span><span class="o">[</span><span class="n">to</span><span class="o">]</span> <span class="o">+=</span> <span class="n">amount</span><span class="o">;</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;%s: %10.2f from %d to %d, Total Balance: %10.2f%n&#34;</span><span class="o">,</span>
                      <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">(),</span>
                      <span class="n">amount</span><span class="o">,</span>
                      <span class="n">from</span><span class="o">,</span>
                      <span class="n">to</span><span class="o">,</span>
                      <span class="n">totalBalance</span><span class="o">());</span>
    <span class="c1">// invoke all waited condition
</span><span class="c1"></span>    <span class="n">suficient</span><span class="o">.</span><span class="na">signalAll</span><span class="o">();</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>此时，当余额不足时，线程不再退出，而时等待其他转账线程唤醒之，知道满足条件继续执行任务</p>

<blockquote>
<ul>
<li>void await() throws InterruptedException;</li>
</ul>

<p>使当前线程等待，当前线程的锁被释放。等待的线程可以被singal()或singalAll()唤醒；若线程被中断也会解除等待状态；解除状态的线程重新<strong>排队获取锁</strong></p>

<ul>
<li>void signalAll();</li>
</ul>

<p>唤醒所有在此条件上等待的线程</p>

<ul>
<li>void signal();</li>
</ul>

<p><strong>选一个</strong>在此条件上等待的线程将其唤醒，此方法具有随机性</p>
</blockquote>

<p>此外，Condition还有一些带有<strong>超时参数</strong>和<strong>阻止中断</strong>的方法，请参照<a href="#https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/Condition.html"> Java SE API</a></p>

<p>到此为止，我们可以利用锁和条件将转账任务改进为线程安全，功能更丰富类：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SynchronizedTransfer</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kt">double</span> <span class="n">INITIAL_MONEY</span> <span class="o">=</span> <span class="n">1000</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="kt">int</span> <span class="n">ACCOUNTS</span> <span class="o">=</span> <span class="n">100</span><span class="o">;</span>
        <span class="n">Bank</span> <span class="n">bank</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bank</span><span class="o">(</span><span class="n">ACCOUNTS</span><span class="o">,</span> <span class="n">INITIAL_MONEY</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACCOUNTS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">TransferTask</span><span class="o">(</span><span class="n">bank</span><span class="o">));</span>
            <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
						<span class="c1">// test thread
</span><span class="c1"></span>            <span class="cm">/* new Thread(new Runnable() {
</span><span class="cm">                @Override
</span><span class="cm">                public void run() {
</span><span class="cm">                    double v = bank.totalBalance();
</span><span class="cm">                    BigDecimal bigDecimal  = new 			BigDecimal(v).setScale(2,BigDecimal.ROUND_HALF_UP);
</span><span class="cm">                    if (bigDecimal.intValue()  != 100000){
</span><span class="cm">                        System.out.println(bigDecimal +  &#34;  is not even!&#34;);
</span><span class="cm">                    }
</span><span class="cm">                }
</span><span class="cm">            }).start();*/</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TransferTask</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="n">Bank</span> <span class="n">bank</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">size</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">double</span> <span class="n">maxAmount</span> <span class="o">=</span> <span class="n">INITIAL_MONEY</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">TransferTask</span><span class="o">(</span><span class="n">Bank</span> <span class="n">bank</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">bank</span> <span class="o">=</span> <span class="n">bank</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">=</span> <span class="n">bank</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">from</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">random</span><span class="o">());</span>
                <span class="kt">int</span> <span class="n">to</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">random</span><span class="o">());</span>
<span class="c1">//                int to = (from + 1 &gt;= size) ? 0 : from + 1;
</span><span class="c1"></span>                <span class="kt">double</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">maxAmount</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">random</span><span class="o">();</span>
                <span class="n">bank</span><span class="o">.</span><span class="na">transfer</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">to</span><span class="o">,</span> <span class="n">amount</span><span class="o">);</span>
                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">((</span><span class="kt">long</span><span class="o">)</span> <span class="o">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()));</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// e.printStackTrace();
</span><span class="c1"></span>            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Bank</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">double</span><span class="o">[]</span> <span class="n">accounts</span><span class="o">;</span>
        <span class="c1">// lock
</span><span class="c1"></span>        <span class="kd">private</span> <span class="n">Lock</span> <span class="n">lock</span><span class="o">;</span>
      	<span class="c1">// condition
</span><span class="c1"></span>        <span class="kd">private</span> <span class="n">Condition</span> <span class="n">suficient</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Bank</span><span class="o">(</span><span class="kt">int</span> <span class="n">accountCount</span><span class="o">,</span> <span class="kt">double</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// initialize bank account
</span><span class="c1"></span>            <span class="n">accounts</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="o">[</span><span class="n">accountCount</span><span class="o">];</span>
            <span class="n">Arrays</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="n">accounts</span><span class="o">,</span> <span class="n">money</span><span class="o">);</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
            <span class="n">suficient</span>  <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="kt">int</span> <span class="n">from</span><span class="o">,</span> <span class="kt">int</span> <span class="n">to</span><span class="o">,</span> <span class="kt">double</span> <span class="n">amount</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">accounts</span><span class="o">[</span><span class="n">from</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// could be interrupted
</span><span class="c1"></span>                    <span class="n">suficient</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                <span class="o">};</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">from</span> <span class="o">==</span> <span class="n">to</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
                <span class="c1">// transfer
</span><span class="c1"></span>                <span class="n">accounts</span><span class="o">[</span><span class="n">from</span><span class="o">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="o">;</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; move away&#34;</span><span class="o">);</span>
                <span class="n">accounts</span><span class="o">[</span><span class="n">to</span><span class="o">]</span> <span class="o">+=</span> <span class="n">amount</span><span class="o">;</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;%s: %10.2f from %d to %d, Total Balance: %10.2f%n&#34;</span><span class="o">,</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">(),</span>
                    <span class="n">amount</span><span class="o">,</span>
                    <span class="n">from</span><span class="o">,</span>
                    <span class="n">to</span><span class="o">,</span>
                    <span class="n">totalBalance</span><span class="o">());</span>
                <span class="c1">// invoke all waited condition
</span><span class="c1"></span>                <span class="n">suficient</span><span class="o">.</span><span class="na">signalAll</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">double</span> <span class="nf">totalBalance</span><span class="o">()</span> <span class="o">{</span>
<span class="c1">//            lock.lock();
</span><span class="c1">//            try {
</span><span class="c1"></span>                <span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">double</span> <span class="n">a</span> <span class="o">:</span> <span class="n">accounts</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sum</span> <span class="o">+=</span> <span class="n">a</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
<span class="c1">//            } finally {
</span><span class="c1">//                lock.unlock();
</span><span class="c1">//            }
</span><span class="c1"></span>        <span class="o">}</span>

        <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">accounts</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>实际上，上例在<strong>totalBalance()方法不加锁的情况下，转账任务也是安全的</strong></p>

<p>回答之前提出的问题：totalBalance()方法究竟是否需要加锁？</p>

<p>请注意main()方法中被注释的部分，它<strong>创建一个线程</strong>（记为T）去读取所有账户的余额，判断余额是否和初始化时相等。使用BigDecimal是为了<strong>处理Double数据类型的精度丢失</strong>。在totalBalance()<strong>不加锁</strong>的情况下，我们很容易看到这样的输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="o">/*</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">0</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]</span> <span class="n">move</span> <span class="n">away</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">0</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]:</span>     <span class="n">793</span><span class="o">.</span><span class="na">81</span> <span class="n">from</span> <span class="n">86</span> <span class="n">to</span> <span class="n">37</span><span class="o">,</span> <span class="n">Total</span> <span class="nl">Balance:</span>  <span class="n">100000</span><span class="o">.</span><span class="na">00</span>
<span class="n">99206</span><span class="o">.</span><span class="na">19</span>  <span class="n">is</span> <span class="n">not</span> <span class="n">even</span><span class="o">!</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">2</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]</span> <span class="n">move</span> <span class="n">away</span>
<span class="n">Thread</span><span class="o">[</span><span class="n">Thread</span><span class="o">-</span><span class="n">2</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">main</span><span class="o">]:</span>     <span class="n">814</span><span class="o">.</span><span class="na">24</span> <span class="n">from</span> <span class="n">30</span> <span class="n">to</span> <span class="n">49</span><span class="o">,</span> <span class="n">Total</span> <span class="nl">Balance:</span>  <span class="n">100000</span><span class="o">.</span><span class="na">00</span>
<span class="o">...</span>
<span class="o">///:~</span></code></pre></td></tr></table>
</div>
</div>
<p>这给出一个暗示：在有其他的线程访问totalBalance()方法时，totalBalance()不是线程安全的。尽管transfer()方法加锁了，任意时刻只有一个线程访问totalBalance()方法，但是T和转账线程不相关，它可<strong>被CPU调度与转账线程竞争对totalBalance()方法中的accounts资源的访</strong>问，正如上述输出所显示的那样</p>

<p><span id="sync_rule">所以，是否加锁应该以<strong>资源是否共享为参照</strong></span></p>

<p>当没有被注释的部分时，由于transfer()方法加锁了，线程在transfer()方法中调用totalBalance()不会受到其他线程的影响；当被注释的线程运行时，这时totalBalance资源可能被共享访问了，为保证安全就必须加锁</p>

<h3 id="13-2-3-synchronized关键字">13.2.3 synchronized关键字</h3>

<p>自Java 1.0开始，每一个对象都有一个隐式<strong>内部锁</strong>（ <em>intrinsic lock</em> ），在Java API Specification中通常被称为<strong>监视器</strong>。这个内部锁由synchronized关键字提供支持。synchronized关键字的语义就是“同步的”，这意味着使用这个关键字可以处理共享资源的冲突</p>

<p>当访问被synchronized关键字保护的方法或代码块时，它将检查锁能否获得——<strong>这个锁可以是当前类对象的锁，也可以是一个临时锁</strong>( <em>ad-hoc lock</em> )，取决你如何使用，任务执行完成之后会释放锁</p>

<p>和ReentrantLock一样，synchronized关键字获取的锁是<strong>独占锁</strong>，并且也是“可重入”的，某个任务可以多次获得对象的锁，并由计数器维护获得锁的次数，当退出一个方法时，计数器-1，完全退出时，才释放锁，这和可重入锁的机制是一样的</p>

<p>类对象也持有一个锁，也就是说synchronized关键字<strong>可作用于静态方法</strong></p>

<p>关于什么时候该使用同步， <em>Brian Goetz</em> 提出过<strong>同步规则</strong>：</p>

<blockquote>
<p>*若向一个变量写入值，它可能接下来被另一个线程读取，或者正在读取一个上一次由另一个线程写过的值，那么必须使用同步，并且读写线程都必须使用<strong>相同的监视器</strong>同步*</p>
</blockquote>

<p><strong>监视器</strong>是由 <em>Per Brinch Hansen</em> 和 <em>Tony Hoare</em> 提出的一种<strong>无锁机制</strong>，最初的监视器具有如下特性：</p>

<ol>
<li>监视器是只包含私有域的类</li>
<li>每个监视器的类对象有一个相关的锁</li>
<li>使用该锁对所有相关的方法加锁</li>
<li>该锁可以有任意多个相关条件</li>
</ol>

<p>Java不完全地采用了监视器的设计概念，这就是synchronized关键字</p>

<p>在<strong>使用synchronized关键字时，将共享域设为私有是非常重要的</strong>。由于域只能通过方法访问，而synchronized保证方法执行的有序性；若域不是私有的，其他任务可以直接操作域，这就可能产生冲突</p>

<h4 id="同步方法">同步方法</h4>

<p>当synchronized关键字作用于方法时，表示这个方法是同步的，执行方法时，首先会尝试获取当前对象的锁——这个对象一般是类的实例对象（ <em>this</em> ），若是静态方法，便是类对象（ <em>Class</em> ）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="kt">int</span> <span class="n">from</span><span class="o">,</span> <span class="kt">int</span> <span class="n">to</span><span class="o">,</span> <span class="kt">double</span> <span class="n">amount</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">accounts</span><span class="o">[</span><span class="n">from</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="o">)</span> <span class="n">wait</span><span class="o">();</span>  <span class="c1">// can be interrupted
</span><span class="c1"></span>  <span class="k">if</span> <span class="o">(</span><span class="n">from</span> <span class="o">==</span> <span class="n">to</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
  <span class="c1">// transfer
</span><span class="c1"></span>  <span class="n">accounts</span><span class="o">[</span><span class="n">from</span><span class="o">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="o">;</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; move away&#34;</span><span class="o">);</span>
  <span class="n">accounts</span><span class="o">[</span><span class="n">to</span><span class="o">]</span> <span class="o">+=</span> <span class="n">amount</span><span class="o">;</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;%s: %10.2f from %d to %d, Total Balance: %10.2f%n&#34;</span><span class="o">,</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">(),</span>
                    <span class="n">amount</span><span class="o">,</span>
                    <span class="n">from</span><span class="o">,</span>
                    <span class="n">to</span><span class="o">,</span>
                    <span class="n">totalBalance</span><span class="o">());</span>
  <span class="n">notifyAll</span><span class="o">();</span>  <span class="c1">// wake up all threads waiting on this monitor
</span><span class="c1"></span><span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>考虑转账的任务，<strong>只需要将transfer()方法加上synchronized关键字即可保证安全</strong>，运行此方法时，线程会先去获取Bank实例的内部锁，并将其他线程阻塞，此线程完成之后会释放这个对象锁，其他线程方可继续运行</p>

<p>继续思考之前的问题，对于synchronized的transfer()方法，里面调用了totalBalance()方法，那totalBalance()方法是否需要同步呢？前面说过「是否加锁应该以<strong><a href="#sync_rule">资源是否共享为参照</a></strong>」，这其实和“同步法则“是的表述是一致的。如果只有多个线程访问transfer()方法，正好此方法是<strong>串行访问</strong>（有序访问）的，那么totalBalance()方法无需同步；若还有其他线程对访问totalBalance()方法的资源，那么必须使用同步</p>

<h4 id="同步代码块">同步代码块</h4>

<p>synchronized关键字也可以用于同步代码块（同步阻塞）</p>

<p>在用于同步方法时，相当于synchronized(this)，而同步代码块则多了一点灵活性</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">synchronized</span> <span class="o">(</span><span class="n">obj</span><span class="o">){</span> <span class="c1">// synchronized block
</span><span class="c1"></span>  <span class="c1">// critical section
</span><span class="c1"></span><span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>示例中的obj可以是 <em>this</em> ，也可以是其他对象</p>

<p>考虑最开始的<a href="#evenGenerator">EvenGenerator</a>类，在next()方法中可以使用同步代码块加锁可保证安全性</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kd">class</span> <span class="nc">EvenGenerator</span> <span class="kd">extends</span> <span class="n">AbstractIntGenerator</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">Integer</span> <span class="n">even</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// equals to using
</span><span class="c1"></span>    <span class="c1">// synchronized (this){
</span><span class="c1"></span>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
      <span class="o">++</span><span class="n">even</span><span class="o">;</span>
      <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
      <span class="o">++</span><span class="n">even</span><span class="o">;</span>
      <span class="c1">// the return statement is not atomic either
</span><span class="c1"></span>      <span class="k">return</span> <span class="n">even</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上例中，synchronized关键字使用了“其他对象”lock的锁，注意，synchronized代码块必须包括所有读写域的代码，<strong>包括return语句</strong></p>

<blockquote>
<p><del>从<a href="#byteCode">字节码</a>来看，return语句也不是原子性的——它要先加载并获取变量域even的值，然后再返回</del></p>

<p>Java语言规范规定对变量的读写都是原子的（long和double）除外，因此return语句是原子的。但是单一语句的原子性并不能保证多线程的安全性，如果锁在return之前被释放，那么return可能获取到其他线程修改后的值</p>
</blockquote>

<p>可以看到，使用synchronized关键字比使用显示锁代码更加简洁</p>

<p>需要注意的是，尽管synchronized代码块中的锁可以是任意对象的，但是尽量不要把这种任意性视为绝对安全的。<strong>一般在同步代码块中使用this或某“不可变”域（上例中）的锁</strong>。</p>

<p>考虑如下示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kd">class</span> <span class="nc">Bank</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">accounts</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Bank</span><span class="o">(</span><span class="kt">int</span> <span class="n">accountCount</span><span class="o">,</span> <span class="kt">double</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// initialize bank account
</span><span class="c1"></span>    <span class="n">accounts</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Vector</span><span class="o">&lt;&gt;(</span><span class="n">accountCount</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">doubles</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">nCopies</span><span class="o">(</span><span class="n">accountCount</span><span class="o">,</span> <span class="n">money</span><span class="o">);</span>
    <span class="n">accounts</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">doubles</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="kt">int</span> <span class="n">from</span><span class="o">,</span> <span class="kt">int</span> <span class="n">to</span><span class="o">,</span> <span class="kt">double</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">accounts</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">accounts</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">from</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">from</span> <span class="o">==</span> <span class="n">to</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
      <span class="c1">// transfer
</span><span class="c1"></span>      <span class="n">accounts</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">accounts</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">from</span><span class="o">)</span> <span class="o">-</span> <span class="n">amount</span><span class="o">);</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; move away&#34;</span><span class="o">);</span>
      <span class="n">accounts</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">to</span><span class="o">,</span> <span class="n">accounts</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">to</span><span class="o">)</span> <span class="o">+</span> <span class="n">amount</span><span class="o">);</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;%s: %10.2f from %d to %d, Total Balance: %10.2f%n&#34;</span><span class="o">,</span>
                        <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">(),</span>
                        <span class="n">amount</span><span class="o">,</span>
                        <span class="n">from</span><span class="o">,</span>
                        <span class="n">to</span><span class="o">,</span>
                        <span class="n">totalBalance</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上例中使用Vector作为账户的容器，Vector()是同步的，是否可以不加锁呢？</p>

<p>不是的，Vector()只能保证其实现方法是同步的，并不能保证transfer方法是同步的。换言之，accounts.set()方法是同步的，其完成之后该线程可能被剥夺运行权</p>

<p>作为改进，在transfer()方法中截获了accounts的锁，尝试使其同步，它是可行的。但是这是否意味着可以任意使用其他对象的锁呢？Java核心卷I给出一段晦涩的评论<sup class="footnote-ref" id="fnref:14"><a href="#fn:14">7</a></sup>：</p>

<p><del>如果冒昧地使用某个其他域（<strong>客户端锁定</strong>）的锁，可能不能保证安全性</del></p>

<blockquote>
<p><em>This approach works, but it is entirely dependent on the fact that the Vector class uses the intrinsic lock for all of its mutator methods. However, is this really a fact? The documentation of the Vector class makes no such promise. You have to carefully study the source code and hope that future versions do not introduce unsynchronized mutators. As you can see, client-side locking is very fragile and not generally recommended.</em></p>
</blockquote>

<p>其晦涩之处在于，synchronized使用accounts的内部锁保证同步，和Vector方法使用的锁是不是accounts的内部锁有什么联系？</p>

<h3 id="13-2-4-原子性与原子类">13.2.4 原子性与原子类</h3>

<p>原子性一般指<strong>原子操作</strong>，原子操作不能<strong>被线程调度机制中断</strong>，一旦操作开始，那么它一定可以在可能发生的上下文切换之前完成。Java语言规范规定了对基本对象(long和double除外)的读写操作是原子的</p>

<p><strong>不能将原子性和同步划等号</strong>！更不能使用原子性来代替同步，当你想使用原子性代替同步写出无锁代码时，思考*Brain Goetz*的建议：</p>

<blockquote>
<p><strong><em>If you can write a high-performance JVM for a modern microprocessor,then you are qualified to think about whether you can avoid synchronizing.</em></strong></p>
</blockquote>

<p>考虑如下几个操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
<span class="kt">boolean</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">flase</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
<span class="n">x</span><span class="o">++;</span>
<span class="kt">double</span> <span class="n">d</span> <span class="o">=</span> <span class="n">1</span><span class="o">.</span><span class="na">9d</span><span class="o">;</span></code></pre></td></tr></table>
</div>
</div>
<p>只有前2个操作是原子操作，后面的操作都不是原子操作</p>

<p>查看一个误用原子性的例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicTest</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// atomic operation
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">increment</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">i</span><span class="o">++;</span>
        <span class="n">i</span><span class="o">++;</span>
      	<span class="c1">// equals to
</span><span class="c1"></span>      	<span class="c1">// i += 2;
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="n">increment</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="n">AtomicTest</span> <span class="n">at</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicTest</span><span class="o">();</span>
        <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">at</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
          	<span class="c1">// the value can still be odd
</span><span class="c1"></span>            <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">%</span> <span class="n">2</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">/*</span> <span class="nl">output:</span> <span class="o">(</span><span class="n">sample</span><span class="o">)</span>
<span class="n">145881</span>
<span class="o">///:~</span></code></pre></td></tr></table>
</div>
</div>
<p>上例过分<strong>高估了原子性的能力</strong>，当另一个线程（mian()线程）调用getValue()去访问共享变量时，尽管getValue()方法只有一个<strong>return</strong>语句，是原子性的，但还是获得了一个不希望的结果——奇数，为什么？虽然increment()方法是同步的，但是getValue()方法不需要锁即可访问共享域，此时的i可能在一个<strong>不稳定的中间状态</strong></p>

<blockquote>
<p>Java内存模型有如下约定<sup class="footnote-ref" id="fnref:16"><a href="#fn:16">8</a></sup></p>

<ol>
<li><p>Java的域都储存在主存（即物理内存）中</p></li>

<li><p>Java的工作线程有独立的内存（CPU缓存）</p></li>

<li><p>同步保证可见性</p></li>

<li><p>原子操作不保证可见性</p></li>
</ol>

<p>依据上面的论断，尝试分析这个不稳定状态：increment()方法使用了同步，即increment()每次自增后都将变量i的结果写入主存；由于getValue()是无锁访问i，它可能获取的可能是increment()方法第一次自增的结果</p>
</blockquote>

<p>那么解决办法有：</p>

<ol>
<li>同步getValue()方法</li>
<li>将2步自增换成一步操作</li>
<li>使用原子类</li>
</ol>

<p>Java SE 5 引入了<code>java.util.concurrent.atomic</code>包，里面提供了原子性变量类，这些类提供了一些原子性操作，实际应用的不多，但合理应用可以提升应用性能</p>

<blockquote>
<p>不要过分依赖原子类，就像不要过分依赖原子性一样</p>
</blockquote>

<p>可以使用AtomicInteger类对AtomicTest类进行优化，使其得到预期的结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicClassTest</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">AtomicInteger</span> <span class="n">i</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// atomic operation
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">i</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 无锁的原因不是因为原子性，而是因为有且只有一个原子操作
</span><span class="cm">     * 若此处使用
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     *     i.incrementAndGet();
</span><span class="cm">     *     i.incrementAndGet();
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     * 那么依旧和{@link AtomicTest}一样失败
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">increment</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">i</span><span class="o">.</span><span class="na">addAndGet</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="n">increment</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="n">AtomicClassTest</span> <span class="n">act</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicClassTest</span><span class="o">();</span>
        <span class="n">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newSingleThreadExecutor</span><span class="o">();</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">act</span><span class="o">);</span>
        <span class="n">ScheduledExecutorService</span> <span class="n">s</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newSingleThreadScheduledExecutor</span><span class="o">();</span>
        <span class="n">s</span><span class="o">.</span><span class="na">schedule</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
          	<span class="c1">// 此方法不会主动退出
</span><span class="c1"></span>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Aborting...&#34;</span><span class="o">);</span>
            <span class="n">executor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
            <span class="n">s</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
        <span class="o">},</span> <span class="n">5</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">act</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="c1">// the value can still be odd
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">%</span> <span class="n">2</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
                <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上面的示例中，方法不用同步，获取到的i的值也不会是奇数</p>

<p>思考这个问题，main()线程每次读取的都是最新修改的i么？</p>

<p>不一定</p>

<p>因为<strong>原子性并不能保证可见性</strong>，main()线程也并不能保证每次获取的都是最新的i值</p>

<h3 id="13-2-5-可见性">13.2.5 可见性</h3>

<p>在讨论原子性的时候，提到了<strong>原子操作并不能保证可见性</strong>。什么是可见性？<strong>可见性</strong>指的是一个变量被被线程修改后，另一个线程能够马上知道这一 修改。</p>

<p>Java SE 5 提供了<strong>volatile</strong>关键字保证可见性，对<strong>volatail</strong>域的修改会马上写入到主存中，其他线程会的本地缓存会失效而从主存中去读取</p>

<p>听起来不错，volatile似乎可以解决资源共享的问题，真的是这样么？</p>

<p>遗憾的是，volatile<strong>并不能保证原子性</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">VolatileIsNotAtomic</span> <span class="o">{</span>

   <span class="c1">// 将变量设置为volatile并不能保证并发安全
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">sum</span><span class="o">;</span>

    <span class="kt">void</span> <span class="nf">increase</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">sum</span><span class="o">++;</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">multiThread2</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">1000</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">increase</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3000</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">sum</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="n">VolatileIsNotAtomic</span> <span class="n">va</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VolatileIsNotAtomic</span><span class="o">();</span>
        <span class="n">va</span><span class="o">.</span><span class="na">multiThread2</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">/*</span> <span class="nl">output:</span><span class="o">(</span><span class="n">sample</span><span class="o">)</span>
<span class="n">8806</span>
<span class="o">///:~</span></code></pre></td></tr></table>
</div>
</div>
<p>上例中将域设置为volatile并不能解决多线程环境下的资源共享问题，原因在于，volatile只保证了可见性，没有保证<strong>共享资源的有序访问</strong></p>

<p>volatile关键字的使用非常有限，当想使用volatile关键字的时候，需要仔细考量，因为其可能有潜在的多线程风险</p>

<p>volatiile关键字最著名的应用是在双重检查( <em>double-check-lock</em> )<a href="https://medium.com/@kevalpatel2106/how-to-make-the-perfect-singleton-de6b951dfdb0">单例</a>中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DoubleCheckSingleton</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">DoubleCheckSingleton</span> <span class="n">instance</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">DoubleCheckSingleton</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">DoubleCheckSingleton</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">DoubleCheckSingleton</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// the double check lock
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DoubleCheckSingleton</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="13-2-6-临界区">13.2.6 临界区</h3>

<p>使用synchronized关键字对整个方法加锁（防止其他线程访问整个方法）往往会带来更大的性能开销，如果你只想保护某些代码块，可以使用<strong>同步代码块</strong>，这一段被锁保护的代码块就称为<strong>临界区</strong>（ <em>critical section</em> ），前面的<strong>显式锁</strong>所保护的区域以及使用<strong>synchronized</strong>保护的代码块都是临界区</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:15">写64位数据的需要2次独立的写入过程，每次写32位
 <a class="footnote-return" href="#fnref:15"><sup>[return]</sup></a></li>
<li id="fn:12">java文件编译的字节码会对Java代码进行拆分
 <a class="footnote-return" href="#fnref:12"><sup>[return]</sup></a></li>
<li id="fn:13">尚不清楚前面aload_0以及dup的意义
 <a class="footnote-return" href="#fnref:13"><sup>[return]</sup></a></li>
<li id="fn:9">可重入锁是典型的独占锁
 <a class="footnote-return" href="#fnref:9"><sup>[return]</sup></a></li>
<li id="fn:11">计数器最大2<sup>31</sup>-1
 <a class="footnote-return" href="#fnref:11"><sup>[return]</sup></a></li>
<li id="fn:10">实际上线程进入同步队列中排队，并自旋尝试获取锁，获取失败则线程的中断状态置位
 <a class="footnote-return" href="#fnref:10"><sup>[return]</sup></a></li>
<li id="fn:14">Java核心技术卷1 第14章并发第14.5.6节同步阻塞
 <a class="footnote-return" href="#fnref:14"><sup>[return]</sup></a></li>
<li id="fn:16">不一定正确，还需要查阅资料进行确认
 <a class="footnote-return" href="#fnref:16"><sup>[return]</sup></a></li>
</ol>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">wangy325</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-05-28
        <a href="https://github.com/wangy325/my_blog/commit/da95f6e88fbd403ff990ab4e42facf895554385c" title="git all hugo site">(da95f6e)</a>
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/endlessriver/img/reward/wechat.png">
        <span>微信打赏</span>
      </label>
    
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/endlessriver/tags/java%E8%BF%9B%E9%98%B6/">Java进阶</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/endlessriver/post/tech/advance_java/%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/">
            <span class="next-text nav-default">线程与任务—Java并发系列之一</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'endlessriver';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=u8za1dzCiImO_8rKldjU1g" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/wangy325" class="iconfont icon-github" title="github"></a>
  <a href="https://wangy325.github.io/endlessriver/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    
    
  </div>

  <span class="copyright-year">
    &copy; 
    2019 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">wangy325</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-cn".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>
<script type="text/javascript" src="/endlessriver/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>








</body>
</html>
