<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>在SpringBoot项目中使用MockMvc进行接口测试 - Endless River</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="wangy325" /><meta name="description" content=" 现在流行在项目中使用swagger对接口进行测试，这确实很方便、直观。
但是MockMvc作为spring-test包中指定的测试框架，在没有使用swagger的项目中，使用其进行测试是很好的选择。
 本文简单介绍在springboot项目中使用Mockito和MockMvc对控制器进行测试。
1 了解Mockito 简单来说，Mockito是一个模拟创建对象的框架，利用它提供的API，可以简化单元测试工作。Mockito的API易读性是很好的，并且错误信息也很简明。spring-boot-starter-test模块中引入了mockito依赖，如果你使用springboot，那么就可以直接使用Mockito进行单元测试。
我们从Mockito官方API文档的的引例开始，看看Mockito是如何工作的。
1.1 mock一个对象 1 2 3 4 5 6 7 8 9 10 11 12 13  // 学会使用静态导入，代码会更简洁  import static org.mockito.Mockito.*; // mock List接口对象  List mockedList = mock(List.class); // 使用Mock的List对象  mockedList.add(&amp;#34;one&amp;#34;); mockedList.clear(); // 校验某个行为是否发生过1次  verify(mockedList).add(&amp;#34;one&amp;#34;); verify(mockedList).clear();   一旦mock对象被创建，mock会记住对其的所有操作，之后，你便可以选择性的校验这些操作。
" />






<meta name="generator" content="Hugo 0.55.6 with even 4.0.0" />


<link rel="canonical" href="https://wangy325.top/post/tech/java/mockmvc%E7%94%A8%E4%BE%8B2%E5%88%99/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.886d4da2.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="在SpringBoot项目中使用MockMvc进行接口测试" />
<meta property="og:description" content="
现在流行在项目中使用swagger对接口进行测试，这确实很方便、直观。

但是MockMvc作为spring-test包中指定的测试框架，在没有使用swagger的项目中，使用其进行测试是很好的选择。


本文简单介绍在springboot项目中使用Mockito和MockMvc对控制器进行测试。

1 了解Mockito

简单来说，Mockito是一个模拟创建对象的框架，利用它提供的API，可以简化单元测试工作。Mockito的API易读性是很好的，并且错误信息也很简明。spring-boot-starter-test模块中引入了mockito依赖，如果你使用springboot，那么就可以直接使用Mockito进行单元测试。

我们从Mockito官方API文档的的引例开始，看看Mockito是如何工作的。

1.1 mock一个对象


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13


 // 学会使用静态导入，代码会更简洁
 import static org.mockito.Mockito.*;

 // mock List接口对象
 List mockedList = mock(List.class);

 // 使用Mock的List对象
 mockedList.add(&#34;one&#34;);
 mockedList.clear();

 // 校验某个行为是否发生过1次
 verify(mockedList).add(&#34;one&#34;);
 verify(mockedList).clear();


一旦mock对象被创建，mock会记住对其的所有操作，之后，你便可以选择性的校验这些操作。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wangy325.top/post/tech/java/mockmvc%E7%94%A8%E4%BE%8B2%E5%88%99/" />
<meta property="article:published_time" content="2021-02-07T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2021-03-09T00:01:55&#43;08:00"/>

<meta itemprop="name" content="在SpringBoot项目中使用MockMvc进行接口测试">
<meta itemprop="description" content="
现在流行在项目中使用swagger对接口进行测试，这确实很方便、直观。

但是MockMvc作为spring-test包中指定的测试框架，在没有使用swagger的项目中，使用其进行测试是很好的选择。


本文简单介绍在springboot项目中使用Mockito和MockMvc对控制器进行测试。

1 了解Mockito

简单来说，Mockito是一个模拟创建对象的框架，利用它提供的API，可以简化单元测试工作。Mockito的API易读性是很好的，并且错误信息也很简明。spring-boot-starter-test模块中引入了mockito依赖，如果你使用springboot，那么就可以直接使用Mockito进行单元测试。

我们从Mockito官方API文档的的引例开始，看看Mockito是如何工作的。

1.1 mock一个对象


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13


 // 学会使用静态导入，代码会更简洁
 import static org.mockito.Mockito.*;

 // mock List接口对象
 List mockedList = mock(List.class);

 // 使用Mock的List对象
 mockedList.add(&#34;one&#34;);
 mockedList.clear();

 // 校验某个行为是否发生过1次
 verify(mockedList).add(&#34;one&#34;);
 verify(mockedList).clear();


一旦mock对象被创建，mock会记住对其的所有操作，之后，你便可以选择性的校验这些操作。">


<meta itemprop="datePublished" content="2021-02-07T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-03-09T00:01:55&#43;08:00" />
<meta itemprop="wordCount" content="7758">



<meta itemprop="keywords" content="测试,mockito," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="在SpringBoot项目中使用MockMvc进行接口测试"/>
<meta name="twitter:description" content="
现在流行在项目中使用swagger对接口进行测试，这确实很方便、直观。

但是MockMvc作为spring-test包中指定的测试框架，在没有使用swagger的项目中，使用其进行测试是很好的选择。


本文简单介绍在springboot项目中使用Mockito和MockMvc对控制器进行测试。

1 了解Mockito

简单来说，Mockito是一个模拟创建对象的框架，利用它提供的API，可以简化单元测试工作。Mockito的API易读性是很好的，并且错误信息也很简明。spring-boot-starter-test模块中引入了mockito依赖，如果你使用springboot，那么就可以直接使用Mockito进行单元测试。

我们从Mockito官方API文档的的引例开始，看看Mockito是如何工作的。

1.1 mock一个对象


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13


 // 学会使用静态导入，代码会更简洁
 import static org.mockito.Mockito.*;

 // mock List接口对象
 List mockedList = mock(List.class);

 // 使用Mock的List对象
 mockedList.add(&#34;one&#34;);
 mockedList.clear();

 // 校验某个行为是否发生过1次
 verify(mockedList).add(&#34;one&#34;);
 verify(mockedList).clear();


一旦mock对象被创建，mock会记住对其的所有操作，之后，你便可以选择性的校验这些操作。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Endless River</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">主题</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a><a href="/friendlink/">
        <li class="mobile-menu-item">友链</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Endless River</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">主题</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/friendlink/">友链</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">在SpringBoot项目中使用MockMvc进行接口测试</h1>

      <div class="post-meta">
          <span>
              <span class="icomoonfree icon-calendar"></span>
              <span class="post-time"> 2021-02-07</span>
          </span>

        <div class="post-category">
              <span class="icomoonfree icon-folder"></span>
            <a href="/categories/java/"> java </a>
            <a href="/categories/springboot/"> springboot </a>
            <a href="/categories/mockito/"> mockito </a>
            </div>
          <span class="icomoonfree icon-sigma"></span>
          <span class="more-meta analyse"> 约 7758 字 </span>
          <span class="icomoonfree icon-clock"></span>
          <span class="more-meta analyse"> 预计阅读 16 分钟 </span>
        <span class="icomoonfree icon-eye"></span>
          <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#1-了解mockito">1 了解Mockito</a>
<ul>
<li><a href="#1-1-mock一个对象">1.1 mock一个对象</a></li>
<li><a href="#1-2-绑定方法参数和返回值">1.2 绑定方法参数和返回值</a></li>
<li><a href="#1-3-参数匹配器">1.3 参数匹配器</a></li>
<li><a href="#1-4-检验方法被调用的次数">1.4 检验方法被调用的次数</a></li>
</ul></li>
<li><a href="#2-使用mockmvc测试控制器">2 使用MockMvc测试控制器</a>
<ul>
<li><a href="#2-1-熟悉这几个静态导入">2.1 熟悉这几个静态导入</a></li>
<li><a href="#2-2-测试示例">2.2 测试示例</a>
<ul>
<li><a href="#2-2-1-简单路径参数get请求测试">2.2.1 简单路径参数GET请求测试</a></li>
<li><a href="#2-2-2-拼接参数的get方法测试">2.2.2 拼接参数的GET方法测试</a></li>
<li><a href="#2-2-3-post请求方法测试">2.2.3 POST请求方法测试</a></li>
</ul></li>
</ul></li>
<li><a href="#3-jsonpath">3 JsonPath</a></li>
<li><a href="#4-补充内容-使用idea直接进行restful接口测试">4 补充内容：使用idea直接进行RESTful接口测试</a></li>
<li><a href="#参考">参考</a></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <blockquote>
<p>现在流行在项目中使用<a href="swagger.io">swagger</a>对接口进行测试，这确实很方便、直观。</p>

<p>但是MockMvc作为spring-test包中指定的测试框架，在没有使用swagger的项目中，使用其进行测试是很好的选择。</p>
</blockquote>

<p>本文简单介绍在springboot项目中使用<a href="https://site.mockito.org/">Mockito</a>和<a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/test/web/servlet/MockMvc.html">MockMvc</a>对控制器进行测试。</p>

<h1 id="1-了解mockito">1 了解Mockito</h1>

<p>简单来说，<a href="https://site.mockito.org/">Mockito</a>是一个模拟创建对象的框架，利用它提供的API，可以简化单元测试工作。Mockito的API易读性是很好的，并且错误信息也很简明。<code>spring-boot-starter-test</code>模块中引入了<code>mockito</code>依赖，如果你使用springboot，那么就可以直接使用Mockito进行单元测试。</p>

<p>我们从Mockito<a href="https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html">官方API文档</a>的的引例开始，看看Mockito是如何工作的。</p>

<h2 id="1-1-mock一个对象">1.1 mock一个对象</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="c1">// 学会使用静态导入，代码会更简洁
</span><span class="c1"></span> <span class="kn">import static</span> <span class="nn">org.mockito.Mockito.*</span><span class="o">;</span>

 <span class="c1">// mock List接口对象
</span><span class="c1"></span> <span class="n">List</span> <span class="n">mockedList</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">List</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

 <span class="c1">// 使用Mock的List对象
</span><span class="c1"></span> <span class="n">mockedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;one&#34;</span><span class="o">);</span>
 <span class="n">mockedList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

 <span class="c1">// 校验某个行为是否发生过1次
</span><span class="c1"></span> <span class="n">verify</span><span class="o">(</span><span class="n">mockedList</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;one&#34;</span><span class="o">);</span>
 <span class="n">verify</span><span class="o">(</span><span class="n">mockedList</span><span class="o">).</span><span class="na">clear</span><span class="o">();</span></code></pre></td></tr></table>
</div>
</div>
<p>一旦mock对象被创建，mock会记住对其的所有操作，之后，你便可以选择性的<span id="v1">校验</span>这些操作。</p>

<h2 id="1-2-绑定方法参数和返回值">1.2 绑定方法参数和返回值</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="c1">// 也可以mock实体类对象
</span><span class="c1"></span> <span class="n">LinkedList</span> <span class="n">mockedList</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">LinkedList</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

 <span class="c1">// 为指定参数的操作绑定返回值（stubbing）
</span><span class="c1"></span> <span class="n">when</span><span class="o">(</span><span class="n">mockedList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="s">&#34;first&#34;</span><span class="o">);</span>
 <span class="n">when</span><span class="o">(</span><span class="n">mockedList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">1</span><span class="o">)).</span><span class="na">thenThrow</span><span class="o">(</span><span class="k">new</span> <span class="n">RuntimeException</span><span class="o">());</span>

 <span class="c1">// 打印 first
</span><span class="c1"></span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">mockedList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">));</span>

 <span class="c1">// 抛出 RunTimeException
</span><span class="c1"></span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">mockedList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">1</span><span class="o">));</span>

 <span class="c1">// 打印null，因为get(999)的返回值没有指定
</span><span class="c1"></span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">mockedList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">999</span><span class="o">));</span>

 <span class="c1">// 尽管也可以对绑定操作进行校验，不过这通常是非必要的
</span><span class="c1"></span> <span class="c1">// 如果你关注get(0)的返回值，那么你应该在代码里进行测试
</span><span class="c1"></span> <span class="c1">// 如果get(0)的返回值无关紧要，那么就没有必要进行绑定
</span><span class="c1"></span> <span class="n">verify</span><span class="o">(</span><span class="n">mockedList</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span></code></pre></td></tr></table>
</div>
</div>
<p>一般来说，对于任意有返回值的方法，mockito都会返回null、原始类型/原始类型的包装类、或者一个空的集合。</p>

<p>返回值的绑定操作<strong>可以被覆盖</strong>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// 返回值的绑定可以连续设置
</span><span class="c1">// 最后一次绑定就是实际调用的返回值
</span><span class="c1">// 例如，mock.someMethod(&#34;some arg&#34;)将返回“foo”
</span><span class="c1"></span><span class="n">when</span><span class="o">(</span><span class="n">mock</span><span class="o">.</span><span class="na">someMethod</span><span class="o">(</span><span class="s">&#34;some arg&#34;</span><span class="o">))</span>
    <span class="o">.</span><span class="na">thenThrow</span><span class="o">(</span><span class="k">new</span> <span class="n">RuntimeException</span><span class="o">())</span>
    <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="s">&#34;foo&#34;</span><span class="o">);</span>

<span class="c1">// 连续绑定的简单形式：
</span><span class="c1"></span><span class="n">when</span><span class="o">(</span><span class="n">mock</span><span class="o">.</span><span class="na">someMethod</span><span class="o">(</span><span class="s">&#34;some arg&#34;</span><span class="o">))</span>
    <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="s">&#34;one&#34;</span><span class="o">,</span> <span class="s">&#34;two&#34;</span><span class="o">);</span>
<span class="c1">// 等价于：
</span><span class="c1"></span><span class="n">when</span><span class="o">(</span><span class="n">mock</span><span class="o">.</span><span class="na">someMethod</span><span class="o">(</span><span class="s">&#34;some arg&#34;</span><span class="o">))</span>
    <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="s">&#34;one&#34;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="s">&#34;two&#34;</span><span class="o">);</span>

<span class="c1">// 抛出异常的简单形式：
</span><span class="c1"></span><span class="n">when</span><span class="o">(</span><span class="n">mock</span><span class="o">.</span><span class="na">someMethod</span><span class="o">(</span><span class="s">&#34;some arg&#34;</span><span class="o">))</span>
    <span class="o">.</span><span class="na">thenThrow</span><span class="o">(</span><span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(),</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">());</span></code></pre></td></tr></table>
</div>
</div>
<p>一旦方法的返回值被绑定，那么其将一直返回绑定的值，无论其被调用多少次。</p>

<h2 id="1-3-参数匹配器">1.3 参数匹配器</h2>

<p>上面形式的返回值绑定在测试时似乎很好用，我们构建参数，设置预期的返回结果，再进行校验即可。但仔细想想，或许少了点什么？对，少了参数的模糊匹配，比如我想绑定<code>get(int)</code>方法的返回值，无论其参数是多少。mockito自然能够为我们做到这些：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="c1">// 使用mockito内建的anyInt()来进行匹配
</span><span class="c1"></span> <span class="n">when</span><span class="o">(</span><span class="n">mockedList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">anyInt</span><span class="o">())).</span><span class="na">thenReturn</span><span class="o">(</span><span class="s">&#34;element&#34;</span><span class="o">);</span>

 <span class="c1">//stubbing using custom matcher (let&#39;s say isValid() returns your own matcher implementation):
</span><span class="c1"></span> <span class="c1">// 使用自定义matcher进行绑定
</span><span class="c1"></span> <span class="n">when</span><span class="o">(</span><span class="n">mockedList</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">argThat</span><span class="o">(</span><span class="n">isValid</span><span class="o">()))).</span><span class="na">thenReturn</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

 <span class="c1">//following prints &#34;element&#34;
</span><span class="c1"></span> <span class="c1">// 打印999
</span><span class="c1"></span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">mockedList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">999</span><span class="o">));</span>

 <span class="c1">// 也可以校验方法被调用了一次
</span><span class="c1"></span> <span class="n">verify</span><span class="o">(</span><span class="n">mockedList</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">anyInt</span><span class="o">());</span>

 <span class="c1">// mockito同样支持java8的lambda表达式进行参数匹配
</span><span class="c1"></span> <span class="n">verify</span><span class="o">(</span><span class="n">mockedList</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">argThat</span><span class="o">(</span><span class="n">someString</span> <span class="o">-&gt;</span> <span class="n">someString</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">5</span><span class="o">));</span></code></pre></td></tr></table>
</div>
</div>
<p>参数匹配可以方便地进行动态返回值绑定校验。</p>

<p>想了解更多关于 argument matcher和hamcrest matcher的内容，可参考：</p>

<ul>
<li><a href="https://javadoc.io/static/org.mockito/mockito-core/3.8.0/org/mockito/ArgumentMatchers.html">https://javadoc.io/static/org.mockito/mockito-core/3.8.0/org/mockito/ArgumentMatchers.html</a></li>
<li><a href="https://javadoc.io/static/org.mockito/mockito-core/3.8.0/org/mockito/hamcrest/MockitoHamcrest.html">https://javadoc.io/static/org.mockito/mockito-core/3.8.0/org/mockito/hamcrest/MockitoHamcrest.html</a></li>
</ul>

<p>除了使用matcher之外，mockito还支持使用类型（class）匹配，这种参数匹配方式在进行MVC测试时，对json参数进行序列化和反序列化时尤其有用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">when</span><span class="o">(</span><span class="n">spittleService</span><span class="o">.</span><span class="na">pageQuerySpittlesByTimeLine</span><span class="o">(</span><span class="n">any</span><span class="o">(</span><span class="n">SpittleDTO</span><span class="o">.</span><span class="na">class</span><span class="o">))).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">page</span><span class="o">);</span>

 <span class="n">ResultActions</span> <span class="n">resultActions</span> <span class="o">=</span> <span class="n">mockMvc</span>
                <span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">MockMvcRequestBuilders</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="s">&#34;/spittle/range/spittles&#34;</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">content</span><span class="o">(</span><span class="n">jsonString</span><span class="o">)</span>
                <span class="o">);</span></code></pre></td></tr></table>
</div>
</div>
<p>就像上面那样，在使用<code>RequestBody</code>传参时，若使用JSON，需要对json字符串进行<strong>反序列化</strong>。这种情形，在进行参数绑定时，自然不能使用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">when</span><span class="o">(</span><span class="n">spittleService</span><span class="o">.</span><span class="na">pageQuerySpittlesByTimeLine</span><span class="o">(</span><span class="n">spittleDTO</span><span class="o">).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">page</span><span class="o">);</span></code></pre></td></tr></table>
</div>
</div>
<p>这样的形式，因为控制器接收到的必然不是这个指定的<code>spittleDTO</code>对象。使用类类型参数，mockito进行参数匹配时，使用<code>equals</code>方法比较的对象的相等性，因此可以获取绑定的返回值。</p>

<blockquote>
<p><a href="https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html#argument_matchers">Sometimes it&rsquo;s just better to refactor the code to allow equals() matching or even implement equals() method to help out with testing</a>.</p>
</blockquote>

<h2 id="1-4-检验方法被调用的次数">1.4 检验方法被调用的次数</h2>

<p><a href="#v1">前文</a>我们提到，<code>verify()</code>方法可以校验指定方法被调用过一次。</p>

<p>mokito提供了更加灵活的校验API，可以用来检验指定方法被调用的次数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//using mock
</span><span class="c1"></span><span class="n">mockedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;once&#34;</span><span class="o">);</span>

<span class="n">mockedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;twice&#34;</span><span class="o">);</span>
<span class="n">mockedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;twice&#34;</span><span class="o">);</span>

<span class="n">mockedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;three times&#34;</span><span class="o">);</span>
<span class="n">mockedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;three times&#34;</span><span class="o">);</span>
<span class="n">mockedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;three times&#34;</span><span class="o">);</span>

<span class="c1">// 当verify方法不指定次数时，默认检验方法调用1次，以下2个调用是等价的
</span><span class="c1"></span><span class="n">verify</span><span class="o">(</span><span class="n">mockedList</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;once&#34;</span><span class="o">);</span>
<span class="n">verify</span><span class="o">(</span><span class="n">mockedList</span><span class="o">,</span> <span class="n">times</span><span class="o">(</span><span class="n">1</span><span class="o">)).</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;once&#34;</span><span class="o">);</span>

<span class="c1">// add(&#34;twice)被调用了2次
</span><span class="c1"></span><span class="n">verify</span><span class="o">(</span><span class="n">mockedList</span><span class="o">,</span> <span class="n">times</span><span class="o">(</span><span class="n">2</span><span class="o">)).</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;twice&#34;</span><span class="o">);</span>
<span class="c1">// add(&#34;three times&#34;)被调用了3次
</span><span class="c1"></span><span class="n">verify</span><span class="o">(</span><span class="n">mockedList</span><span class="o">,</span> <span class="n">times</span><span class="o">(</span><span class="n">3</span><span class="o">)).</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;three times&#34;</span><span class="o">);</span>

<span class="c1">// add(&#34;never happened&#34;)方法没有被调用
</span><span class="c1">// 等价于 times(0)
</span><span class="c1"></span><span class="n">verify</span><span class="o">(</span><span class="n">mockedList</span><span class="o">,</span> <span class="n">never</span><span class="o">()).</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;never happened&#34;</span><span class="o">);</span>

<span class="c1">// 使用atLeast()/atMost()可以校验参数至少/至多被调用几次
</span><span class="c1"></span><span class="n">verify</span><span class="o">(</span><span class="n">mockedList</span><span class="o">,</span> <span class="n">atMostOnce</span><span class="o">()).</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;once&#34;</span><span class="o">);</span>
<span class="n">verify</span><span class="o">(</span><span class="n">mockedList</span><span class="o">,</span> <span class="n">atLeastOnce</span><span class="o">()).</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;three times&#34;</span><span class="o">);</span>
<span class="n">verify</span><span class="o">(</span><span class="n">mockedList</span><span class="o">,</span> <span class="n">atLeast</span><span class="o">(</span><span class="n">2</span><span class="o">)).</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;three times&#34;</span><span class="o">);</span>
<span class="n">verify</span><span class="o">(</span><span class="n">mockedList</span><span class="o">,</span> <span class="n">atMost</span><span class="o">(</span><span class="n">5</span><span class="o">)).</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;three times&#34;</span><span class="o">);</span></code></pre></td></tr></table>
</div>
</div>
<p><code>times(1)</code>是默认，因此<code>verify(mockedList, times(1)).add(&quot;once&quot;)</code>这样的形式是不必要的。</p>

<p>除了上面介绍的之外，moikito还有很多使用的测试方法，具体可以参考API文档：</p>

<ul>
<li><a href="https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html#in_order_verification">https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html#in_order_verification</a></li>
</ul>

<h1 id="2-使用mockmvc测试控制器">2 使用MockMvc测试控制器</h1>

<p>介绍了mockito的基本用法，可以开始用它测试控制器了。</p>

<p>spring web项目的测试使用的是Spring MVC测试框架（*Spring MVC Test framework(MockMvc)*），其使用方式和Mockito很像，实际上MockMvc借用了Mockito的API，因此，熟悉Mockito的使用对使用MockMVC测试web服务大有裨益。</p>

<h2 id="2-1-熟悉这几个静态导入">2.1 熟悉这几个静态导入</h2>

<ul>
<li>MockMvcBuilders.*</li>
<li>MockMvcRequestBuilders.*</li>
<li>MockMvcResultMatchers.*</li>
<li>MockMvcResultHandlers.*</li>
</ul>

<p>和Mockito一样，熟悉并使用静态导入会让代码看起来更简洁。不过，对刚使用MockMVC进行测试的新手来说，使用静态导入可能会陷入一个麻烦：方法这么多，我怎么记得这个方法该使用哪个静态导入，容易陷入混乱。</p>

<p>不过，记住他们的惯用法就行了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// MockMvcBuilders.* 用于构建MockMvc应用
</span><span class="c1"></span><span class="n">MockMvc</span> <span class="n">mockMvc</span> <span class="o">=</span> <span class="n">MockMvcBuilders</span><span class="o">.</span><span class="na">stansaloneSetup</span><span class="o">(</span><span class="n">controller</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>

<span class="c1">// MockMvcRequestBuilders.*用于构建请求
</span><span class="c1"></span><span class="n">ResultActions</span> <span class="n">resultActions</span> <span class="o">=</span> <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">MockMvcRequestBuilders</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">url</span><span class="o">));</span>
<span class="n">ResultActions</span> <span class="n">resultActions</span> <span class="o">=</span> <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">MockMvcRequestBuilders</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="n">url</span><span class="o">));</span>

<span class="c1">// MockMvcResultMatchers.*用于请求结果匹配
</span><span class="c1"></span><span class="n">resultActions</span><span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">MockMvcResultMatchers</span><span class="o">.</span><span class="na">status</span><span class="o">().</span><span class="na">isOK</span><span class="o">())</span>

<span class="c1">// MockMvcResultHandlers.* 嘛，用得少，其提供一个print()方法，可以打印请求信息
</span><span class="c1"></span><span class="n">resultActions</span><span class="o">.</span><span class="na">andDo</span><span class="o">(</span><span class="n">MockMvcResultHandlers</span><span class="o">.</span><span class="na">print</span><span class="o">());</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="2-2-测试示例">2.2 测试示例</h2>

<p>在进行<span id="start">单元测试</span>时，通常习惯将通用模版进行抽象，本示例中也是如此，我们建立一个抽象测试类，用于准备数据、提供<span id="jsonpath">通用方法</span>等：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@SpringBootTest</span>
<span class="nd">@TestPropertySource</span><span class="o">(</span><span class="s">&#34;classpath:application-test.properties&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BaseMockInit</span> <span class="o">{</span>

<span class="c1">//    @Autowired
</span><span class="c1">//    protected ObjectMapper objectMapper;
</span><span class="c1"></span>    <span class="kd">protected</span> <span class="n">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="n">Jackson2ObjectMapperBuilder</span><span class="o">.</span><span class="na">json</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>


    <span class="kd">protected</span> <span class="nd">@Mock</span>
    <span class="n">ISpitterService</span> <span class="n">spitterService</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="nd">@Mock</span>
    <span class="n">ISpittleService</span> <span class="n">spittleService</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="n">SpitterController</span> <span class="n">spitterController</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="n">SpittleController</span> <span class="n">spittleController</span><span class="o">;</span>

    <span class="nd">@BeforeEach</span>
    <span class="kt">void</span> <span class="nf">initMock</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">MockitoAnnotations</span><span class="o">.</span><span class="na">initMocks</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">spitterController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpitterController</span><span class="o">();</span>
        <span class="n">spitterController</span><span class="o">.</span><span class="na">setSpitterService</span><span class="o">(</span><span class="n">spitterService</span><span class="o">);</span>
        <span class="n">spittleController</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpittleController</span><span class="o">();</span>
        <span class="n">spittleController</span><span class="o">.</span><span class="na">setSpittleService</span><span class="o">(</span><span class="n">spittleService</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>你可能注意到上面的示例中使用的<code>@Mock</code>注解和<code>MockitoAnnotations.initMocks(this);</code>方法，实际作用就是mock web测试中所需要使用到的服务层service，因为测试web模块不涉及到数据服务层的业务，因此借助Mockito即可轻松创建测试所需要的实例。</p>

<h3 id="2-2-1-简单路径参数get请求测试">2.2.1 简单路径参数GET请求测试</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">getSpitterById</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">SpitterVO</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpitterVO</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="s">&#34;alan&#34;</span><span class="o">,</span> <span class="s">&#34;walker&#34;</span><span class="o">,</span> <span class="s">&#34;aw&#34;</span><span class="o">,</span> <span class="s">&#34;xxx&#34;</span><span class="o">);</span>
    <span class="n">Spitter</span> <span class="n">spitter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Spitter</span><span class="o">();</span>
    <span class="n">BeanUtils</span><span class="o">.</span><span class="na">copyBeanProp</span><span class="o">(</span><span class="n">spitter</span><span class="o">,</span> <span class="n">source</span><span class="o">);</span>

    <span class="n">when</span><span class="o">(</span><span class="n">spitterService</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="n">1</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">spitter</span><span class="o">);</span>
    <span class="n">spitterController</span><span class="o">.</span><span class="na">setSpitterService</span><span class="o">(</span><span class="n">spitterService</span><span class="o">);</span>
    <span class="n">MockMvc</span> <span class="n">mockMvc</span> <span class="o">=</span> <span class="n">standaloneSetup</span><span class="o">(</span><span class="n">spitterController</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="c1">// perform get request with path variables
</span><span class="c1"></span>    <span class="n">ResultActions</span> <span class="n">resultActions</span> <span class="o">=</span> <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">&#34;/spitter/1&#34;</span><span class="o">));</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">resultActions</span><span class="o">.</span><span class="na">andReturn</span><span class="o">().</span><span class="na">getResponse</span><span class="o">().</span><span class="na">getContentAsString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
    <span class="n">resultActions</span><span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
            <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">content</span><span class="o">().</span><span class="na">contentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">))</span>
            <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">&#34;$.data&#34;</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">.</span><span class="na">convertValue</span><span class="o">(</span><span class="n">spitter</span><span class="o">,</span> <span class="n">HashMap</span><span class="o">.</span><span class="na">class</span><span class="o">)));</span>

    <span class="n">verify</span><span class="o">(</span><span class="n">spitterService</span><span class="o">).</span><span class="na">getById</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>观察上面的测试用例，我们首先使用Mockito对数据层的mock对象进行了参数和返回值绑定，这在前文已经提及：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">when</span><span class="o">(</span><span class="n">spitterService</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="n">1</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">spitter</span><span class="o">);</span></code></pre></td></tr></table>
</div>
</div>
<p>随即使用MockMvc发起<code>get</code>请求，发起请求的方式有多种：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">ResultActions</span> <span class="n">resultActions</span> <span class="o">=</span> <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">&#34;/spitter/1&#34;</span><span class="o">));</span>
<span class="c1">// 等价于
</span><span class="c1"></span><span class="n">ResultActions</span> <span class="n">resultActions</span> <span class="o">=</span> <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">&#34;/spitter/{id}&#34;</span><span class="o">,</span> <span class="n">1</span><span class="o">));</span></code></pre></td></tr></table>
</div>
</div>
<p>当请求进入控制器时，根据控制器的业务逻辑，调用<code>spitterService.getById(1)</code>方法，该方法返回之前绑定的返回值，进行封装之后，返回web请求的结果。</p>

<p>上述请求返回一个<code>ResultActions</code>结果，web请求的结果被封装在内，我们可以对这个结果进行校验：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">resultActions</span><span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
            <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">content</span><span class="o">().</span><span class="na">contentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">))</span>
            <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">&#34;$.data&#34;</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">.</span><span class="na">convertValue</span><span class="o">(</span><span class="n">spitter</span><span class="o">,</span> <span class="n">HashMap</span><span class="o">.</span><span class="na">class</span><span class="o">)));</span></code></pre></td></tr></table>
</div>
</div>
<p>注意到，<code>jsonPath(&quot;$.data&quot;)</code>，这意味着请求返回的json字串中包含一个<code>data</code>键，<code>.value()</code>操作暗示其对应的内容就是<code>spitterService.getById(1)</code>的返回对象。所以这个请求返回的json应该像这样：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;ok&#34;</span><span class="p">,</span>
    <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nt">&#34;usename&#34;</span><span class="p">:</span> <span class="s2">&#34;aw&#34;</span><span class="p">,</span>
        <span class="nt">&#34;firstname&#34;</span><span class="p">:</span> <span class="s2">&#34;alan&#34;</span><span class="p">,</span>
        <span class="nt">&#34;lastname&#34;</span><span class="p">:</span> <span class="s2">&#34;walker&#34;</span><span class="p">,</span>
        <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;xxx&#34;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">&#34;$.data&#34;</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">.</span><span class="na">convertValue</span><span class="o">(</span><span class="n">spitter</span><span class="o">,</span> <span class="n">HashMap</span><span class="o">.</span><span class="na">class</span><span class="o">)));</span></code></pre></td></tr></table>
</div>
</div>
<p>的<span id="path">意义</span>是比较通过<code>jsonPath(&quot;$.data&quot;)</code>解析到的对象和<code>objectMapper.convertValue(spitter, HashMap.class))</code>获取到的对象的相等性。</p>

<p>实际上，通过<code>jsonPath(&quot;$.data&quot;)</code>获取到的内容是一个LinkedHashMap，而<code>.value()</code>的相等性比较的是map中对应键的值的相等性，<strong>单单从这个示例</strong>来讲，这个比较是可行的<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>。</p>

<p>最后，我们使用<code>verify</code>方法对mock对象的方法调用进行了测试：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="n">verify</span><span class="o">(</span><span class="n">spitterService</span><span class="o">).</span><span class="na">getById</span><span class="o">(</span><span class="n">1</span><span class="o">);</span></code></pre></td></tr></table>
</div>
</div>
<p>不过，由于我们已经校验了web接口的返回值，那么mock对象的方法一定被调用了，所以一般我们无需这么做。</p>

<h3 id="2-2-2-拼接参数的get方法测试">2.2.2 拼接参数的GET方法测试</h3>

<p>除了路径参数，使用最多的就是形如<code>?para1=xxx&amp;para2=xxx</code>这样的请求参数，MockMvc同样对这样的web服务提供测试支持</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">getUserSpittlesPageTest</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="c1">// ... 省略准备数据
</span><span class="c1"></span>
    <span class="c1">// 此处必须使用类类型作为参数
</span><span class="c1"></span>    <span class="n">when</span><span class="o">(</span><span class="n">spittleService</span><span class="o">.</span><span class="na">pageQuerySpittleBySpitterId</span><span class="o">(</span><span class="n">any</span><span class="o">(</span><span class="n">SpittleDTO</span><span class="o">.</span><span class="na">class</span><span class="o">))).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">page</span><span class="o">);</span>

    <span class="c1">// perform get with request params transferred by pojo
</span><span class="c1"></span>    <span class="n">ResultActions</span> <span class="n">resultActions</span> <span class="o">=</span> <span class="n">mockMvc</span>
        <span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">&#34;/spittle/user/spittles?spitterId={spitterId}&#34;</span><span class="o">,</span> <span class="n">4</span><span class="o">))</span>
        <span class="c1">// get element from json
</span><span class="c1"></span>        <span class="c1">// see https://github.com/json-path/JsonPath
</span><span class="c1"></span>        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">&#34;$.data.currentPage&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="n">pageDomain</span><span class="o">.</span><span class="na">getCurrentPage</span><span class="o">()))</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">&#34;$.data.pageSize&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="n">pageDomain</span><span class="o">.</span><span class="na">getPageSize</span><span class="o">()))</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">&#34;$.data.pages&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="n">pageDomain</span><span class="o">.</span><span class="na">getPages</span><span class="o">()))</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">&#34;$.data.total&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="n">pageDomain</span><span class="o">.</span><span class="na">getTotal</span><span class="o">()))</span>
        <span class="o">.</span><span class="na">andDo</span><span class="o">(</span><span class="n">print</span><span class="o">());</span>
        <span class="cm">/* 报错原因 ：long和integer的问题*/</span>
<span class="c1">//            .andExpect(jsonPath(&#34;$.data.records[0]&#34;)
</span><span class="c1">//                .value(objectMapper.convertValue(sample, HashMap.class)));
</span><span class="c1"></span>
    <span class="n">String</span> <span class="n">jsonResult</span> <span class="o">=</span> <span class="n">resultActions</span><span class="o">.</span><span class="na">andReturn</span><span class="o">().</span><span class="na">getResponse</span><span class="o">().</span><span class="na">getContentAsString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">jsonResult</span><span class="o">);</span>
    <span class="c1">// verify is not necessary here
</span><span class="c1"></span>    <span class="n">verify</span><span class="o">(</span><span class="n">spittleService</span><span class="o">).</span><span class="na">pageQuerySpittleBySpitterId</span><span class="o">(</span><span class="n">any</span><span class="o">(</span><span class="n">SpittleDTO</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>

    <span class="n">assertEquals</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">jsonPathParser</span><span class="o">(</span><span class="n">jsonResult</span><span class="o">).</span><span class="na">read</span><span class="o">(</span><span class="s">&#34;$.data.records.length()&#34;</span><span class="o">),</span> <span class="n">1</span><span class="o">);</span>
    <span class="n">SpittleVO</span> <span class="n">rvo</span> <span class="o">=</span> <span class="n">jsonPathParser</span><span class="o">(</span><span class="n">jsonResult</span><span class="o">).</span><span class="na">read</span><span class="o">(</span><span class="s">&#34;$.data.records[0]&#34;</span><span class="o">,</span> <span class="n">SpittleVO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">sample</span><span class="o">,</span> <span class="n">rvo</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这个测试和上一个测试有一些区别，首先第一个区别就是mock对象的参数与返回值绑定方式变了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="n">when</span><span class="o">(</span><span class="n">spittleService</span><span class="o">.</span><span class="na">pageQuerySpittleBySpitterId</span><span class="o">(</span><span class="n">any</span><span class="o">(</span><span class="n">SpittleDTO</span><span class="o">.</span><span class="na">class</span><span class="o">))).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">page</span><span class="o">);</span></code></pre></td></tr></table>
</div>
</div>
<p>多数情况下，我们不会直接在控制器中使用具体的参数，而是使用Java Bean作为控制器的参数。这个时候，Spring MVC的<code>MappingJasksonHttpMessageConverter</code>将会发挥作用<sup class="footnote-ref" id="fnref:2"><a href="#fn:2">2</a></sup>，将请求中的中的参数转换为对应的Java Bean实例。</p>

<p>这样一来，我们便不能指定某一个实例作为mock对象的参数了，只能使用<code>any(class)</code>这样的形式进行模糊匹配。</p>

<p>其次，关于使用地址栏参数的参数传递，除了使用上述的方式（最简单）之外，还有其他的方式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="n">ResultActions</span> <span class="n">resultActions</span> <span class="o">=</span> <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">&#34;/spittle/user/spittles?spitterId={spitterId}&#34;</span><span class="o">,</span> <span class="n">4</span><span class="o">))</span>
  <span class="c1">// 等价于
</span><span class="c1"></span>  <span class="n">ResultActions</span> <span class="n">resultActions</span> <span class="o">=</span> <span class="n">mockMvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">&#34;/spittle/user&#34;</span><span class="o">)).</span><span class="na">param</span><span class="o">(</span><span class="s">&#34;spitterId&#34;</span><span class="o">,</span> <span class="n">4</span><span class="o">)</span></code></pre></td></tr></table>
</div>
</div>
<p>第三，如果再次使用类似于<a href="#path">上一个示例</a>那样校验返回数据的方法校验<code>$.data.records[0]</code>，将会得到一个错误。原因也和前文描述的一样。我们必须使用更为稳妥的方法。</p>

<p>第四，对于同一个控制器的测试，我们可以预先做一些设置，比如依赖<code>@BeforeEach</code>注解，约定好一些通用的内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">MyWebTests</span> <span class="o">{</span>

    <span class="n">MockMvc</span> <span class="n">mockMvc</span><span class="o">;</span>

    <span class="nd">@BeforeEach</span>
    <span class="kt">void</span> <span class="nf">init</span><span class="o">(){</span>
        <span class="n">mockMvc</span> <span class="o">=</span> <span class="n">standaloneSetup</span><span class="o">(</span><span class="n">spittleController</span><span class="o">)</span>
                <span class="o">.</span><span class="na">alwaysExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
                <span class="o">.</span><span class="na">alwaysExpect</span><span class="o">(</span><span class="n">content</span><span class="o">().</span><span class="na">contentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">))</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>上述方法在每一个测试之前准备mockMvc对象，并且约定了servlet的返回状态和返回类型。</p>

<h3 id="2-2-3-post请求方法测试">2.2.3 POST请求方法测试</h3>

<p>如前所述，在发起<span id = "post">POST请求</span>时，一般使用JSON，此时<code>MappingJasksonHttpMessageConverter</code>便会介入。它负责将JSON对象反序列化为控制器指定的Java Baean。在使用MockMvc进行测试时，我们直接使用JSON字符串，将其设置在请求体中即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">postSpittlesTimeLinePageTest</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="c1">// ... 省略其他设置
</span><span class="c1"></span>    <span class="n">dto</span><span class="o">.</span><span class="na">setLeftTime</span><span class="o">(</span><span class="n">LocalDateTime</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">&#34;2012-06-09T00:00:00.000&#34;</span><span class="o">));</span>
    <span class="n">dto</span><span class="o">.</span><span class="na">setRightTime</span><span class="o">(</span><span class="n">LocalDateTime</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">&#34;2012-06-09T23:59:59.999&#34;</span><span class="o">));</span>

    <span class="n">when</span><span class="o">(</span><span class="n">spittleService</span><span class="o">.</span><span class="na">pageQuerySpittlesByTimeLine</span><span class="o">(</span><span class="n">any</span><span class="o">(</span><span class="n">SpittleDTO</span><span class="o">.</span><span class="na">class</span><span class="o">))).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">page</span><span class="o">);</span>

    <span class="c1">// perform post request
</span><span class="c1"></span>    <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">objectMapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">dto</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;request body: {}&#34;</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>
    <span class="n">ResultActions</span> <span class="n">resultActions</span> <span class="o">=</span> <span class="n">mockMvc</span>
        <span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">post</span><span class="o">(</span><span class="s">&#34;/spittle/range/spittles&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
            <span class="o">.</span><span class="na">characterEncoding</span><span class="o">(</span><span class="s">&#34;utf8&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">content</span><span class="o">(</span><span class="n">s</span><span class="o">))</span>
        <span class="o">.</span><span class="na">andDo</span><span class="o">(</span><span class="n">print</span><span class="o">());</span>

    <span class="c1">// 以下用来获取MockMvc返回(Json)
</span><span class="c1"></span>    <span class="n">String</span> <span class="n">jsonResult</span> <span class="o">=</span> <span class="n">resultActions</span><span class="o">.</span><span class="na">andReturn</span><span class="o">().</span><span class="na">getResponse</span><span class="o">().</span><span class="na">getContentAsString</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">jsonResult</span><span class="o">);</span>

    <span class="n">PageDomain</span><span class="o">&lt;</span><span class="n">SpittleVO</span><span class="o">&gt;</span> <span class="n">rpg</span> <span class="o">=</span> <span class="n">jsonPathParser</span><span class="o">(</span><span class="n">jsonResult</span><span class="o">).</span><span class="na">read</span><span class="o">(</span><span class="s">&#34;$.data&#34;</span><span class="o">,</span> <span class="n">PageDomain</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">jsonPathParser</span><span class="o">(</span><span class="n">jsonResult</span><span class="o">).</span><span class="na">read</span><span class="o">(</span><span class="s">&#34;$.data.records.length()&#34;</span><span class="o">),</span> <span class="n">1</span><span class="o">);</span>
    <span class="n">SpittleVO</span> <span class="n">rvo</span> <span class="o">=</span> <span class="n">jsonPathParser</span><span class="o">(</span><span class="n">jsonResult</span><span class="o">).</span><span class="na">read</span><span class="o">(</span><span class="s">&#34;$.data.records[0]&#34;</span><span class="o">,</span> <span class="n">SpittleVO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">rpg</span><span class="o">.</span><span class="na">setRecords</span><span class="o">(</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">SpittleVO</span><span class="o">&gt;()</span> <span class="o">{{</span>
        <span class="n">add</span><span class="o">(</span><span class="n">rvo</span><span class="o">);</span>
    <span class="o">}});</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">rpg</span><span class="o">,</span> <span class="n">pageDomain</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>可以看到，发起POST请求的方式比较简单：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"> <span class="n">ResultActions</span> <span class="n">resultActions</span> <span class="o">=</span> <span class="n">mockMvc</span>
        <span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">post</span><span class="o">(</span><span class="s">&#34;/spittle/range/spittles&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
            <span class="o">.</span><span class="na">characterEncoding</span><span class="o">(</span><span class="s">&#34;utf8&#34;</span><span class="o">)</span>
            <span class="o">.</span><span class="na">content</span><span class="o">(</span><span class="n">s</span><span class="o">));</span></code></pre></td></tr></table>
</div>
</div>
<p>设置好请求头接受的文件类型和编码，使用<code>content(json)</code>方法传入json字符串即可。</p>

<p>在本节的<a href="#start">开头</a>，我们进行了一些通用的配置，你可能暂时还没有注意到这个细节：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//    @Autowired
</span><span class="c1">//    protected ObjectMapper objectMapper;
</span><span class="c1"></span>    <span class="kd">protected</span> <span class="n">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="n">Jackson2ObjectMapperBuilder</span><span class="o">.</span><span class="na">json</span><span class="o">().</span><span class="na">build</span><span class="o">();</span></code></pre></td></tr></table>
</div>
</div>
<p>我们注释掉了spring自动装配的<code>ObjectMapper</code>，转而使用了<code>Jackson2ObjectMapperBuilder</code>构建了一个默认的<code>ObjectMapper</code>，这样做是有原因的：</p>

<p>对于spring自动装配的<code>ObjectMapper</code>，我们在项目改变了其对<code>LocalDateTime</code>的序列化与反序列化规则：</p>

<blockquote>
<p>对于<code>LocalDateTime</code>，默认情况下其字符串输出格式类似于<code>2012-06-09T23:59:59.999</code>，这样的字符串形式非常不利于页面传递参数，因此我们在项目配置中改变了其规则，使得在实际使用时，能够将<code>2012-06-09 23:59:59.999</code>形式的日期字符串直接转化为<code>LocalDateTime</code>对象；反之，<code>LocalDateTime</code>也将会直接转化为<code>2012-06-09 23:59:59.999</code>的形式返回。</p>
</blockquote>

<p>但是在使用MockMvc进行测试时，其进行反序列化时（将请求JSON转化为Java Bean），使用的可能是默认的消息转换规则。而当我们使用自动装配的<code>ObjectMapper</code>将配置好的Bean转化为JSON时，时间的字符串形式是<code>2012-06-09 23:59:59.999</code>，默认的消息转换无法将其转化为<code>LocaldateTime</code>，因此会出现<strong>转换异常</strong>。</p>

<p>关于<code>ObjactMapper</code>的详细内容，会在后续博客中详细介绍。</p>

<h1 id="3-jsonpath">3 JsonPath</h1>

<p>看到这里，你可能对使用Mockito和MockMvc进行测试有了初步的了解。不过如果你细心的话，就会发现，前面的测试用例对最后的接口的返回校验都没有提及。并且示例代码中关于提取返回内容出现最多的字就是<code>jsonPath</code>。</p>

<p>并且在前面的测试用例中，我们也通过简单的表达式<code>jsonPath(&quot;$.data&quot;)</code>提取了返回JSON中的结果。</p>

<p>实际上，Spring MockMvc默认是支持使用JsonPath获取返回内容的，就像<code>jsonPath(&quot;$.data&quot;)</code>那样，不过其灵活性没有直接使用JspnPath大，特别是在反序列化的操作上。</p>

<p>很多时候，RESTful接口返回的内容实际上是Java Bean序列化之后的JSON串，所以我们希望将获取到的JSON反序列化之后再进行校验，而MockMvc在这方面表现的就比较蹩脚了，其只能转化为Map进行比较，就像<a href="#path">###2.2.1节</a>中表现的那样<sup class="footnote-ref" id="fnref:3"><a href="#fn:3">3</a></sup>。</p>

<p>说实话，测试在获取到返回的JSON串，通过控制台打印输出确认符合预期基本上就可以结束，再去检验JSON的内容有点<strong>强迫症</strong>的意味了。</p>

<p>其实在<a href="https://github.com/json-path/JsonPath">JsonPath</a>的仓库里详细地介绍了JsonPath的基本用法，针对本实例的具体情况，通过阅读文档，我们可以很容易取得想要的值并进行校验。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;code&#34;</span><span class="p">:</span><span class="mi">20000</span><span class="p">,</span>
    <span class="nt">&#34;msg&#34;</span><span class="p">:</span><span class="s2">&#34;http.ok&#34;</span><span class="p">,</span>
    <span class="nt">&#34;data&#34;</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="nt">&#34;currentPage&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&#34;pageSize&#34;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
            <span class="nt">&#34;total&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
            <span class="nt">&#34;pages&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&#34;records&#34;</span><span class="p">:</span>
                <span class="p">[</span>
                    <span class="p">{</span>
                    <span class="nt">&#34;id&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                    <span class="nt">&#34;spitterId&#34;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                    <span class="nt">&#34;message&#34;</span><span class="p">:</span><span class="s2">&#34;sixth man&#34;</span><span class="p">,</span>
                    <span class="nt">&#34;time&#34;</span><span class="p">:</span><span class="s2">&#34;2012-06-09 22:20:00&#34;</span><span class="p">,</span>
                    <span class="nt">&#34;latitude&#34;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span>
                    <span class="nt">&#34;longitude&#34;</span><span class="p">:</span><span class="mf">0.0</span>
                    <span class="p">}</span>
                <span class="p">]</span>
        <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>我们要校验的就是<code>data</code>中的内容，现在我们再回过头来看看上面的<a href="#post">测试代码</a>，实际上很容易理解:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">PageDomain</span><span class="o">&lt;</span><span class="n">SpittleVO</span><span class="o">&gt;</span> <span class="n">rpg</span> <span class="o">=</span> <span class="n">jsonPathParser</span><span class="o">(</span><span class="n">jsonResult</span><span class="o">).</span><span class="na">read</span><span class="o">(</span><span class="s">&#34;$.data&#34;</span><span class="o">,</span> <span class="n">PageDomain</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">jsonPathParser</span><span class="o">(</span><span class="n">jsonResult</span><span class="o">).</span><span class="na">read</span><span class="o">(</span><span class="s">&#34;$.data.records.length()&#34;</span><span class="o">),</span> <span class="n">1</span><span class="o">);</span>
    <span class="n">SpittleVO</span> <span class="n">rvo</span> <span class="o">=</span> <span class="n">jsonPathParser</span><span class="o">(</span><span class="n">jsonResult</span><span class="o">).</span><span class="na">read</span><span class="o">(</span><span class="s">&#34;$.data.records[0]&#34;</span><span class="o">,</span> <span class="n">SpittleVO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">rpg</span><span class="o">.</span><span class="na">setRecords</span><span class="o">(</span><span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">SpittleVO</span><span class="o">&gt;()</span> <span class="o">{{</span>
        <span class="n">add</span><span class="o">(</span><span class="n">rvo</span><span class="o">);</span>
    <span class="o">}});</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">rpg</span><span class="o">,</span> <span class="n">pageDomain</span><span class="o">);</span></code></pre></td></tr></table>
</div>
</div>
<p>首先我们获取了<code>$.data</code>节点的内容，里面也是一个Json对象，按照*传统的*反序列化理解，这是一个Java Bean，我们该如何将其读取为我们程序中的Bean呢，JsonPath也<a href="https://github.com/json-path/JsonPath#what-is-returned-when">作了说明</a></p>

<blockquote>
<p>默认情况下，通过<code>JsonPath.parse(json).read(&quot;$.data&quot;)</code>获取的到的是Map实例，并不会映射为Java Bean。不过JsonPath也为此提供了可能：
&gt; If you configure JsonPath to use JacksonMappingProvider or GsonMappingProvider you can even map your JsonPath output directly into POJO&rsquo;s.</p>
</blockquote>

<p>要想映射为JavaBean，我们需要：</p>

<ul>
<li>自定义配置JsonProvider</li>
<li>传入类型参数</li>
</ul>

<p>配置JsonProvider的方式也很简单：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/**
</span><span class="cm">    * Use json-path, tweaking configuration&lt;br&gt;
</span><span class="cm">    * The config below change default action of json-path&lt;br&gt;
</span><span class="cm">    * Use application-context ObjectMapper config as json and mapper provider&lt;br&gt;
</span><span class="cm">    * &lt;p&gt;
</span><span class="cm">    * Reference: &lt;a href=&#34;https://github.com/json-path/JsonPath&#34;&gt;
</span><span class="cm">    * https://github.com/json-path/JsonPath&lt;/a&gt;
</span><span class="cm">    *
</span><span class="cm">    * @param json standard json string
</span><span class="cm">    * @return {@link DocumentContext}
</span><span class="cm">    */</span>
<span class="kd">protected</span> <span class="n">DocumentContext</span> <span class="nf">jsonPathParser</span><span class="o">(</span><span class="n">String</span> <span class="n">json</span><span class="o">)</span> <span class="o">{</span>

    <span class="kd">final</span> <span class="n">JsonProvider</span> <span class="n">jsonProvider</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JacksonJsonProvider</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">MappingProvider</span> <span class="n">mappingProvider</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JacksonMappingProvider</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">);</span>
    <span class="n">Configuration</span><span class="o">.</span><span class="na">setDefaults</span><span class="o">(</span><span class="k">new</span> <span class="n">Configuration</span><span class="o">.</span><span class="na">Defaults</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">JsonProvider</span> <span class="nf">jsonProvider</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">jsonProvider</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Option</span><span class="o">&gt;</span> <span class="nf">options</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">EnumSet</span><span class="o">.</span><span class="na">noneOf</span><span class="o">(</span><span class="n">Option</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">MappingProvider</span> <span class="nf">mappingProvider</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">mappingProvider</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">});</span>
    <span class="k">return</span> <span class="n">JsonPath</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">json</span><span class="o">);</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>此时，我们就已经获取到了接口返回的对象。不过等等，我们再仔细看看上面的Json，会发现<code>$.data.records</code>节点是一个数组，数组里面又是可以映射为Java Bean的Json。而经过上一步，获取的<code>PageDomain</code>对象中的<code>records</code>域实际上还是一个<code>List&lt;Map&gt;</code>的默认映射结果，所以我们还需要梅开二度。</p>

<h1 id="4-补充内容-使用idea直接进行restful接口测试">4 补充内容：使用idea直接进行RESTful接口测试</h1>

<p>到这里，本文的主要内容就结束了。</p>

<p>如果你使用的IDEA，你不妨找找<code>tools-&gt;httpClients</code>，你会发现，idea的绝妙功能：其可以通过脚本文件测试rest接口。</p>

<p>idea提供了不同HTTP请求的脚本示例，很容易就能上手，脚本文件以<code>.http</code>结尾，你可轻松创建自己的测试脚本。</p>

<p>例如，我为上面的测试创建一个名为<code>rest-api.http</code>的脚本：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-http" data-lang="http"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-http" data-lang="http"><span class="err">### get spitter info by spitterId
</span><span class="err">GET {{host}}/spitter/{{spitterId}}?lang={{lang}}
</span><span class="err">Accept: application/json
</span><span class="err">
</span><span class="err">
</span><span class="err">### 分页获取spittle， 根据用户spitterId，请求参数放在GET请求体中的情形:
</span><span class="err">GET {{host}}/spittle/user/spittles?lang={{lang}}
</span><span class="err">Accept: */*
</span><span class="err">Content-Type: application/json
</span><span class="err">
</span><span class="err">{
</span><span class="err">  &#34;spitterId&#34;: 4,
</span><span class="err">  &#34;currentPage&#34;: 1,
</span><span class="err">  &#34;pageSize&#34;: 1
</span><span class="err">}
</span><span class="err">
</span><span class="err">
</span><span class="err">### 分页获取某个时间段的spittle 1
</span><span class="err">POST {{host}}/spittle/range/spittles?lang={{lang}}
</span><span class="err">Content-Type: application/json
</span><span class="err">
</span><span class="err">{
</span><span class="err">  &#34;leftTime&#34;: &#34;2012-06-09 00:00:00&#34;,
</span><span class="err">  &#34;rightTime&#34;: &#34;2012-06-09 23:59:59&#34;,
</span><span class="err">  &#34;currentPage&#34;:2,
</span><span class="err">  &#34;pageSize&#34;: 1
</span><span class="err">}</span></code></pre></td></tr></table>
</div>
</div>
<p>可以看到，<code>.http</code>脚本文件的可读性非常强。其中，为了方便，还使用了用双花括号语法的<strong>环境变量</strong>，这些变量被命名在一个名为<code>http-client-env.json</code>的json文件中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;mem&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;host&#34;</span><span class="p">:</span><span class="s2">&#34;http://localhost:9000/mem&#34;</span><span class="p">,</span>
    <span class="nt">&#34;spitterId&#34;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="nt">&#34;lang&#34;</span><span class="p">:</span> <span class="s2">&#34;en&#34;</span><span class="p">,</span>
    <span class="nt">&#34;currentPage&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&#34;pageSize&#34;</span><span class="p">:</span> <span class="mi">2</span>
  <span class="p">},</span>
  <span class="nt">&#34;mysql&#34;</span><span class="p">:{</span>
    <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:9100/dev&#34;</span><span class="p">,</span>
    <span class="nt">&#34;spitterId&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nt">&#34;lang&#34;</span><span class="p">:</span> <span class="s2">&#34;en&#34;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>运行脚本时，可以通过执行环境配置传入不同的测试参数，就这么简单。</p>

<hr />

<h1 id="参考">参考</h1>

<ul>
<li>本文用例所在项目地址：<a href="https://github.com/wangy325/mybatis-plus-starter">https://github.com/wangy325/mybatis-plus-starter</a></li>
<li>mockito官网：<a href="https://site.mockito.org/">https://site.mockito.org/</a></li>
<li>mockito API官网：<a href="https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html">https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html</a></li>
<li>MockMvc java doc：<a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/test/web/servlet/MockMvc.html">https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/test/web/servlet/MockMvc.html</a></li>
<li>json-path仓库介绍了其基本使用方法：<a href="https://github.com/json-path/JsonPath">https://github.com/json-path/JsonPath</a></li>
<li>可能出现的bug：<a href="https://stackoverflow.com/questions/47276920/mockito-error-however-there-was-exactly-1-interaction-with-this-mock">https://stackoverflow.com/questions/47276920/mockito-error-however-there-was-exactly-1-interaction-with-this-mock</a></li>
<li>MockMvc官方文档：<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/testing.html#spring-mvc-test-framework">https://docs.spring.io/spring-framework/docs/current/reference/html/testing.html#spring-mvc-test-framework</a></li>
<li>MockMVC官方测试示例代码库：<a href="https://github.com/spring-projects/spring-framework/tree/master/spring-test/src/test/java/org/springframework/test/web/servlet/samples">https://github.com/spring-projects/spring-framework/tree/master/spring-test/src/test/java/org/springframework/test/web/servlet/samples</a></li>
</ul>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">这种形式的比较往往会出现问题，例如，如果pojo类中的<code>id</code>字段定义为<code>Long</code>型，使用objectMapper进行转换的时候*可能*会转换为<code>Integer</code>型。
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2">关于Spring MVC的消息转换器，参考《Spring实战，第4版》第16章相关内容。
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
<li id="fn:3">或许笔者还没有找到更加优雅的方法。
 <a class="footnote-return" href="#fnref:3"><sup>[return]</sup></a></li>
</ol>
</div>
    </div>

    <div class="post-copyright">
  
  <p class="copyright-item" style= text-align:right;>
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-03-09
        <a href="https://github.com/wangy325/endlessriver/commit/2b40450fc45a1062b73cd2edbb35d1ef4e9b18a8" title="uddate update date for doc mockMvc">(2b40450)</a>
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E6%B5%8B%E8%AF%95/">测试</a>
          <a href="/tags/mockito/">mockito</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/tech/java/use-springboot-messagesource/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">在SpringBoot中使用MessageSource</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/tech/java/java-new-time-api/">
            <span class="next-text nav-default">Java8中的新日期和时间工具库</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'endlessriver';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=u8za1dzCiImO_8rKldjU1g" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/wangy325" class="iconfont icon-github" title="github"></a>
  <a href="https://wangy325.top/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme -
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    
    
  </div>

  <span class="copyright-year">
    <span class="author">wangy325</span>
    &copy;
    2019 -
    2021
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="copyright"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND</a></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-cn".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script><script></script><script src="https://cdn.jsdelivr.net/npm/raphael@2.2.7/raphael.min.js" integrity="sha256-67By+NpOtm9ka1R6xpUefeGOY8kWWHHRAKlvaTJ7ONI=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/flowchart.js@1.8.0/release/flowchart.min.js" integrity="sha256-zNGWjubXoY6rb5MnmpBNefO0RgoVYfle9p0tvOQM+6k=" crossorigin="anonymous"></script><script></script><script src="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.js" integrity="sha256-4O4pS1SH31ZqrSO2A/2QJTVjTPqVe+jnYgOWUVr7EEc=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/snapsvg@0.5.1/dist/snap.svg-min.js" integrity="sha256-oI+elz+sIm+jpn8F/qEspKoKveTc5uKeFHNNVexe6d8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/underscore@1.8.3/underscore-min.js" integrity="sha256-obZACiHd7gkOk9iIL/pimWMTJ4W/pBsKu+oZnSeBIek=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/gh/bramp/js-sequence-diagrams@2.0.1/dist/sequence-diagram-min.js" integrity="sha384-8748Vn52gHJYJI0XEuPB2QlPVNUkJlJn9tHqKec6J3q2r9l8fvRxrgn/E5ZHV0sP" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/bramp/js-sequence-diagrams@2.0.1/dist/sequence-diagram-min.css" integrity="sha384-6QbLKJMz5dS3adWSeINZe74uSydBGFbnzaAYmp+tKyq60S7H2p6V7g1TysM5lAaF" crossorigin="anonymous">
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      TeX: {equationNumbers: {autoNumber: "AMS"}},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>








</body>
</html>
